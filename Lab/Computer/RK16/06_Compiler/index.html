<!-- (ฅ^･ω･^ฅ) ﾆｬｰ -->

<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja" prefix="og: http://ogp.me/ns#">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-114187773-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag("js", new Date());
    gtag("config", "UA-114187773-1");
  </script>
  <!-- End Google Analytics -->
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="@kanade_k_1228" />
  <link rel="shortcut icon" href="https://avatars.githubusercontent.com/u/54773334" />
      <title>コンパイラ | Kanade's Website</title>

  <!-- OGP -->
    <!-- END OGP -->
  <style>
    body {
      margin: 0;
      /* background-color: #fcfeff; */
      /* background-color: #e4f0fc; */
      background-color: #f0f8ff;
      font-size: 16px;
      font-family: メイリオ, Meiryo, 游ゴシック体, "Yu Gothic", YuGothic,
        "ヒラギノ角ゴシック Pro", "Hiragino Kaku Gothic Pro", Osaka,
        "ＭＳ Ｐゴシック", "MS PGothic", sans-serif;
      line-height: 1.5;
      color: #202020;
    }

    article {
      display: block;
      margin: 0 auto;
    }

    @media (min-width: 1220px) {
      article {
        width: 1200px;
      }
    }

    @media (max-width: 1219px) {
      article {
        width: 100%;
      }
    }

    h1 {
      display: block;
      margin: 0.5em 0 0.5em 0;
      padding: 8px;
      color: #d64acf;
      font-size: 25px;
      font-weight: bold;
      background-color: #ffccff;
    }

    h2 {
      display: block;
      margin: 0.5em 0 0.5em 0;
      padding: 8px;
      color: #2c8ecf;
      font-size: 20px;
      font-weight: bold;
      background: #bbddff;
    }

    h3 {
      font-weight: bold;
      margin: 1em 0 0.5em 0.5em;
    }

    h4 {
      font-weight: bold;
      margin: 0.5em 0 0.5em 0.7em;
    }

    p {
      margin: 0.5em 0 0.5em 1em;
    }

    small {
      font-size: 10px;
    }

    table {
      margin: 0.5em auto;
      border-collapse: collapse;
    }

    th {
      border: 1px solid;
      padding: 0.3em;
      text-align: center;
      background-color: #e8ffbd;
    }

    td {
      border: 1px solid;
      padding: 0.3em;
      text-align: center;
      background-color: #f0f0ff;
    }

    ul,
    ol {
      margin: 0.5em 0 0.5em 1em;
      padding: 0 0 0 1.5em;
    }

    ul ul,
    ul ul ul,
    ol ol,
    ol ol ol {
      margin: 0;
    }

    blockquote {
      border: 1px solid;
      border-radius: 2px;
      background-color: white;
      margin: 0.5em 1em 0.5em 1em;
    }

    img {
      display: block;
      margin: 0 auto;
      max-width: 100%;
      min-width: 50%;
    }

    header>ul {
      margin: 0.5em 0 0.5em 0;
      padding: 0;
      list-style: none;
      display: flex;
      flex-direction: row;
    }

    header>ul>li {
      width: 25%;
      text-align: center;
    }

    header>ul>li>a {
      display: block;
    }

    div#header-links {
      height: 50px;
      display: flex;
      margin: 0.5em 0 0.5em 0;
      justify-content: space-evenly;
    }

    div#header-links>a {
      text-decoration: none;
    }

    nav {
      border: 1px solid;
      border-radius: 2px;
      background-color: white;
      margin: 0.5em 1em 0.5em 1em;
    }

    nav>ul {
      margin: 0;
    }

    button {
      display: block;
      margin: 0.5em auto;
    }

    iframe {
      display: block;
      margin: 0.5em auto;
    }

    code {
      display: inline-block;
      padding: 1px;
      border: solid;
      border-width: 1px;
      border-radius: 5px;
      background: #ffffff;
    }
  </style>
  <style>
    a.sourceLine {
      display: inline-block;
      line-height: 1.25;
    }

    a.sourceLine {
      pointer-events: none;
      color: inherit;
      text-decoration: inherit;
    }

    a.sourceLine:empty {
      height: 1.2em;
    }

    .sourceCode {
      overflow: visible;
      font-family: Consolas, Menlo, "Liberation Mono", Courier, monospace;
    }

    code.sourceCode {
      white-space: pre;
      position: relative;
    }

    div.sourceCode {
      margin: 0.5em 1em 0.5em 1em;
    }

    pre.sourceCode {
      margin: 0;
    }

    @media screen {
      div.sourceCode {
        overflow: auto;
      }
    }

    @media print {
      code.sourceCode {
        white-space: pre-wrap;
      }

      a.sourceLine {
        text-indent: -1em;
        padding-left: 1em;
      }
    }

    pre.numberSource a.sourceLine {
      position: relative;
      left: -4em;
    }

    pre.numberSource a.sourceLine::before {
      content: attr(title);
      position: relative;
      left: -1em;
      text-align: right;
      vertical-align: baseline;
      border: none;
      pointer-events: all;
      display: inline-block;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      padding: 0 4px;
      width: 4em;
      color: #aaaaaa;
    }

    pre.numberSource {
      margin-left: 3em;
      border-left: 1px solid #aaaaaa;
      padding-left: 4px;
    }

    div.sourceCode {
      color: rgb(212, 212, 212);
      background-color: rgb(0, 0, 0);
    }

    @media screen {
      a.sourceLine::before {
        text-decoration: underline;
      }
    }

    code span.al {
      color: #ef2929;
    }

    /* Alert */
    code span.an {
      color: #8f5902;
      font-weight: bold;
      font-style: italic;
    }

    /* Annotation */
    code span.at {
      color: #c4a000;
    }

    /* Attribute */
    code span.bn {
      color: rgb(86, 156, 214);
    }

    /* BaseN */
    code span.cf {
      color: rgb(197, 134, 192);
      font-weight: bold;
    }

    /* ControlFlow */
    code span.ch {
      color: #4e9a06;
    }

    /* Char */
    code span.cn {
      color: rgb(181, 206, 168);
    }

    /* Constant */
    code span.co {
      color: rgb(106, 153, 85);
    }

    /* Comment */
    code span.cv {
      color: #8f5902;
      font-weight: bold;
      font-style: italic;
    }

    /* CommentVar */
    code span.do {
      color: #8f5902;
      font-weight: bold;
      font-style: italic;
    }

    /* Documentation */
    code span.dt {
      color: rgb(86, 156, 214);
    }

    /* DataType */
    code span.dv {
      color: rgb(181, 206, 168);
    }

    /* DecVal */
    code span.er {
      color: #a40000;
      font-weight: bold;
    }

    /* Error */
    code span.ex {}

    /* Extension */
    code span.fl {
      color: rgb(181, 206, 168);
    }

    /* Float */
    code span.fu {
      color: rgb(220, 220, 170);
    }

    /* Function */
    code span.im {
      color: rgb(206, 145, 120);
    }

    /* Import */
    code span.in {
      color: #8f5902;
      font-weight: bold;
      font-style: italic;
    }

    /* Information */
    code span.kw {
      color: rgb(78, 201, 176);
      font-weight: bold;
    }

    /* Keyword */
    code span.op {}

    /* Operator */
    code span.ot {
      color: #8f5902;
    }

    /* Other */
    code span.pp {
      color: rgb(197, 134, 192);
    }

    /* Preprocessor */
    code span.sc {
      color: rgb(215, 186, 125);
    }

    /* SpecialChar */
    code span.ss {
      color: #4e9a06;
    }

    /* SpecialString */
    code span.st {
      color: rgb(206, 145, 120);
    }

    /* String */
    code span.va {
      color: rgb(156, 220, 254);
    }

    /* Variable */
    code span.vs {
      color: #4e9a06;
    }

    /* VerbatimString */
    code span.wa {
      color: #8f5902;
      font-weight: bold;
      font-style: italic;
    }

    /* Warning */
  </style>
    <script type="text/javascript" id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <style>
    mjx-container[jax="CHTML"][display="true"] {
      display: block;
      text-align: center;
      margin: 0;
    }
  </style>
  <!-- SyntaxHighlight -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/vs2015.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/highlight.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
  </script>

  <script>
    function tweet() {
      window.open(
        "https://twitter.com/intent/tweet?via=kanade_k_1228&related=kanade_k_1228&url=" +
        location.href +
        "&text=" +
        "コンパイラ",
        "_blank"
      );
    }
  </script>
</head>

<body>
  <article>
    <header>
      <ul>
        <li><a href="/">ﾎｰﾑ</a></li>
        <li><a href="/Portfolio/">ﾎﾟﾄﾌｫﾘｵ</a></li>
        <li><a href="/Lab/">研究室</a></li>
        <li><a href="/Blog/">雑記</a></li>
      </ul>
      <div id="header-links">
        <a href="https://twitter.com/kanade_k_1228" target="_blank">
          <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="126.444 2.281 589 589"
            style="margin: 0; padding: 0">
            <circle cx="420.944" cy="296.781" r="294.5" fill="#2daae1" />
            <path
              d="M609.773 179.634c-13.891 6.164-28.811 10.331-44.498 12.204 16.01-9.587 28.275-24.779 34.066-42.86a154.78 154.78 0 0 1-49.209 18.801c-14.125-15.056-34.267-24.456-56.551-24.456-42.773 0-77.462 34.675-77.462 77.473 0 6.064.683 11.98 1.996 17.66-64.389-3.236-121.474-34.079-159.684-80.945-6.672 11.446-10.491 24.754-10.491 38.953 0 26.875 13.679 50.587 34.464 64.477a77.122 77.122 0 0 1-35.097-9.686v.979c0 37.54 26.701 68.842 62.145 75.961-6.511 1.784-13.344 2.716-20.413 2.716-4.998 0-9.847-.473-14.584-1.364 9.859 30.769 38.471 53.166 72.363 53.799-26.515 20.785-59.925 33.175-96.212 33.175-6.25 0-12.427-.373-18.491-1.104 34.291 21.988 75.006 34.824 118.759 34.824 142.496 0 220.428-118.052 220.428-220.428 0-3.361-.074-6.697-.236-10.021a157.855 157.855 0 0 0 38.707-40.158z"
              fill="#fff" />
          </svg>
        </a>
        <a href="https://github.com/kanade-k-1228" target="_blank">
          <svg width="50px" height="50px" viewBox="0 0 1024 1024" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" clip-rule="evenodd"
              d="M8 0C3.58 0 0 3.58 0 8C0 11.54 2.29 14.53 5.47 15.59C5.87 15.66 6.02 15.42 6.02 15.21C6.02 15.02 6.01 14.39 6.01 13.72C4 14.09 3.48 13.23 3.32 12.78C3.23 12.55 2.84 11.84 2.5 11.65C2.22 11.5 1.82 11.13 2.49 11.12C3.12 11.11 3.57 11.7 3.72 11.94C4.44 13.15 5.59 12.81 6.05 12.6C6.12 12.08 6.33 11.73 6.56 11.53C4.78 11.33 2.92 10.64 2.92 7.58C2.92 6.71 3.23 5.99 3.74 5.43C3.66 5.23 3.38 4.41 3.82 3.31C3.82 3.31 4.49 3.1 6.02 4.13C6.66 3.95 7.34 3.86 8.02 3.86C8.7 3.86 9.38 3.95 10.02 4.13C11.55 3.09 12.22 3.31 12.22 3.31C12.66 4.41 12.38 5.23 12.3 5.43C12.81 5.99 13.12 6.7 13.12 7.58C13.12 10.65 11.25 11.33 9.47 11.53C9.76 11.78 10.01 12.26 10.01 13.01C10.01 14.08 10 14.94 10 15.21C10 15.42 10.15 15.67 10.55 15.59C13.71 14.53 16 11.53 16 8C16 3.58 12.42 0 8 0Z"
              transform="scale(64)" fill="#1B1F23" />
          </svg>
        </a>
        <a href="https://t.co/E5xtfEQs4A" target="_blank">
          <img src="http://kanade-k-1228.github.io/img/niconico.png" width="50px" height="50px"
            style="border-radius: 50%" /></a>
        <a href="https://www.youtube.com/channel/UCoeuc9-XQ5EpeYSCn4ESpQw" target="_blank">
          <svg width="50px" height="50px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 333333 333333">
            <path
              d="M166667 0c92048 0 166667 74619 166667 166667s-74619 166667-166667 166667S0 258715 0 166667 74619 0 166667 0zm84195 132297s-1678-11849-6843-17052c-6545-6843-13873-6887-17223-7283-24036-1751-60138-1751-60138-1751h-63s-36085 0-60135 1751c-3363 409-10681 437-17223 7283-5168 5203-6811 17052-6811 17052s-1711 13904-1711 27838v13029c0 13905 1709 27837 1709 27837s1678 11849 6811 17061c6542 6843 15139 6621 18977 7350 13761 1314 58457 1710 58457 1710s36133-64 60169-1783c3363-397 10678-438 17223-7284 5168-5202 6843-17065 6843-17065s1711-13904 1711-27837v-13028c-35-13905-1745-27837-1745-27837l-9 9-1-1zm-102010 56674v-48312l46437 24237-46437 24075z"
              fill="red" />
          </svg>
        </a>
      </div>
      <!-- End Top Nav -->
      <!-- Title -->
            <h1 style="margin: 0">コンパイラ</h1>
            <!-- Date -->
            <!-- Description -->
          </header>

    <!-- TeX Macros -->
    <!-- prettier-ignore -->
    <p style="display: none">
      \[ \newcommand{dn}[3]{\frac{\mathrm{d}^{#3} #1}{\mathrm{d} #2^{#3}}}
      \newcommand{\d}[2]{\frac{\mathrm{d} #1}{\mathrm{d} #2}}
      \newcommand{\dd}[2]{\frac{\mathrm{d}^2 #1}{\mathrm{d} {#2}^2}}
      \newcommand{\ddd}[2]{\frac{\mathrm{d}^3 #1}{\mathrm{d} {#2}^3}}
      \newcommand{\pdn}[3]{\frac{\partial^{#3} #1}{\partial {#2}^{#3}}}
      \newcommand{\pd}[2]{\frac{\partial #1}{\partial #2}}
      \newcommand{\pdd}[2]{\frac{\partial^2 #1}{\partial {#2}^2}}
      \newcommand{\pddd}[2]{\frac{\partial^3 #1}{\partial {#2}^3}}
      \newcommand{\p}{\partial}
      \newcommand{\D}[2]{\frac{\mathrm{D} #1}{\mathrm{D} #2}}
      \newcommand{\Re}{\mathrm{Re}}
      \newcommand{\Im}{\mathrm{Im}}
      \newcommand{\bra}[1]{\left\langle #1 \right|}
      \newcommand{\ket}[1]{\left|#1 \right\rangle}
      \newcommand{\braket}[2]{\left\langle #1 \middle|#2 \right\rangle}
      \newcommand{\inner}[2]{\left\langle #1 ,#2 \right\rangle}
      \newcommand{\l}{\left} \newcommand{\m}{\middle} \newcommand{\r}{\right}
      \newcommand{\f}[2]{\frac{#1}{#2}} \newcommand{\eps}{\varepsilon}
      \newcommand{\ra}{\rightarrow} \newcommand{\F}{\mathcal{F}}
      \newcommand{\L}{\mathcal{L}} \newcommand{\t}{\quad}
      \newcommand{\intinf}{\int_{-\infty}^{+\infty}}
      \newcommand{\R}{\mathcal{R}} \newcommand{\C}{\mathcal{C}}
      \newcommand{\Z}{\mathcal{Z}} \newcommand{\bm}[1]{\boldsymbol{#1}} \]
    </p>

    <!-- Table of Contents -->
        <nav><ul>
<li><a href="#型">型</a>
<ul>
<li><a href="#型の書き方">型の書き方</a></li>
<li><a href="#参照演算子アドレス演算子">参照演算子・アドレス演算子</a></li>
<li><a href="#キャスト演算子">キャスト演算子</a></li>
<li><a href="#整数型">整数型</a></li>
<li><a href="#ポインタ型">ポインタ型</a></li>
<li><a href="#配列型">配列型</a></li>
<li><a href="#構造体型">構造体型</a></li>
<li><a href="#関数型">関数型</a></li>
</ul></li>
<li><a href="#プログラム">プログラム</a>
<ul>
<li><a href="#文">文</a></li>
<li><a href="#式">式</a></li>
<li><a href="#値">値</a></li>
</ul></li>
<li><a href="#コンパイラの動作">コンパイラの動作</a>
<ul>
<li><a href="#トークン化">トークン化</a></li>
<li><a href="#抽象構文木の構築">抽象構文木の構築</a></li>
<li><a href="#シンボルテーブル生成">シンボルテーブル生成</a></li>
<li><a href="#astの再帰的評価">ASTの再帰的評価</a></li>
<li><a href="#アセンブラコードの生成">アセンブラコードの生成</a></li>
<li><a href="#グローバル変数の配置">グローバル変数の配置</a></li>
<li><a href="#関数のコード生成">関数のコード生成</a></li>
</ul></li>
<li><a href="#作業日誌">作業日誌</a></li>
<li><a href="#参考">参考</a></li>
</ul></nav>
     <p>自作マイコン用の自作言語、C– (Cょゎょゎ) のコンパイラです。</p>
<blockquote>
<p>組み込みシステムを作るために実用上十分な機能を持つこと</p>
</blockquote>
<blockquote>
<p>コンパイラの実装が簡単になること</p>
</blockquote>
<blockquote>
<p>文法がわかりやすいこと</p>
</blockquote>
<h2 id="型">型</h2>
<table>
<thead>
<tr class="header">
<th></th>
<th>記法</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>整数型</td>
<td><code>int</code></td>
</tr>
<tr class="even">
<td>ポインタ型</td>
<td><code>*int</code></td>
</tr>
<tr class="odd">
<td>配列型</td>
<td><code>[N]int</code></td>
</tr>
<tr class="even">
<td>構造体型</td>
<td><code>{m0 : int, m1 : int}</code></td>
</tr>
<tr class="odd">
<td>関数型</td>
<td><code>(a0 : int, a1 : int) =&gt; int</code></td>
</tr>
</tbody>
</table>
<pre><code>type =
 | type_prim   = ident | &quot;(&quot; type &quot;)&quot;
 | type_ptr    = &quot;*&quot; type
 | type_arr    = &quot;[&quot; expr &quot;]&quot; type
 | type_struct = &quot;{&quot; (ident &quot;:&quot; type) % &quot;,&quot; &quot;}&quot;
 | type_func   = &quot;(&quot; (ident &quot;:&quot; type) % &quot;,&quot; &quot;)&quot; &quot;=&gt;&quot; type</code></pre>
<p>ポインタ <code>*</code>、配列 <code>[]</code> をベース型の前に置きます。</p>
<h3 id="型の書き方">型の書き方</h3>
<p><code>var hoge : int</code></p>
<p>コロンの後に型を書きます。これによって複合型の型がわかりやすくなります。</p>
<h3 id="参照演算子アドレス演算子">参照演算子・アドレス演算子</h3>
<p><code>a*</code> で <code>a</code> をポインタとみなして、<code>a</code> の指す値を得ます。</p>
<p><code>a : *int</code> → <code>a* : int</code></p>
<p><code>a@</code> で <code>a</code> のアドレスを得ます。</p>
<p><code>a : int</code> → <code>a@ : *int</code></p>
<h3 id="キャスト演算子">キャスト演算子</h3>
<p><code>a : T</code></p>
<p>変数の後に型を書いて、キャストができます。</p>
<p><code>sizeof(a) == sizeof(T)</code></p>
<p>メモリ上でサイズが同じならキャストができます。</p>
<p>後置演算子 <code>$</code> で変数をブーリアン型にします。</p>
<p><code>a : int = 0</code> → <code>a$ = false</code></p>
<h3 id="整数型">整数型</h3>
<p>16bit 整数。 符号付きか無しかについては未定。 ハードウェアとかの都合で決める。</p>
<h3 id="ポインタ型">ポインタ型</h3>
<p>ポインタ型は 16bit のアドレスです。 これはアドレス空間が 16bit であることに由来します。</p>
<p>アクセス演算子を適用すると、ベース型になります。</p>
<p><code>hoge : *int</code> → <code>hoge* : int</code></p>
<p>アドレス演算子を適用すると、ポインタ型になります。</p>
<p><code>hoge : int</code> → <code>hoge@ : *int</code></p>
<h3 id="配列型">配列型</h3>
<p>配列はコンパイル時にベース型の N 個分のメモリを確保します。</p>
<p>添字演算子を適用すると、ベースの型になります。</p>
<p><code>hoge : [N]int</code> → <code>hoge[0] : int</code></p>
<p>多次元配列は、このように表されます。</p>
<p><code>hoge : [N][M]int</code></p>
<p>C言語と異なり、配列とポインタの暗黙のキャストは行いません。</p>
<p>配列のアドレスが欲しい場合は、アドレス演算子を使います。</p>
<p><code>hoge : [N]int</code> → <code>hoge@ : *[N]int</code></p>
<p>配列の先頭の要素のアドレスは、このように取得します。</p>
<p><code>hoge : [N]int</code> → <code>hoge[0]@ : *int</code></p>
<p>これらのポインタの値は一致しますが、型は異なります。</p>
<h3 id="構造体型">構造体型</h3>
<p>構造体のサイズはメンバの合計です。</p>
<p>メンバ演算子を適用すると、メンバの型になります。</p>
<p><code>hoge : {a : int}</code> → <code>hoge.a : int</code></p>
<h3 id="関数型">関数型</h3>
<p>関数型は関数の持つ型です。</p>
<p>関数呼び出し演算子を適用すると、返り値の型になります。</p>
<p><code>hoge : (arg : Arg) =&gt; Ret</code> → <code>hoge(arg) : Ret</code></p>
<p>関数型の変数は定義できません。かわりに関数ポインタ型を使います。</p>
<p><code>var hoge_p : *(arg : Arg) =&gt; Ret = hoge@;</code> → <code>hoge_p*(arg) : Ret</code></p>
<p>関数ポインタには関数のアドレスが入ってます。</p>
<h2 id="プログラム">プログラム</h2>
<table>
<thead>
<tr class="header">
<th></th>
<th>記法</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>変数定義</td>
<td><code>var  hoge : int;</code></td>
</tr>
<tr class="even">
<td>関数定義</td>
<td><code>func hoge : (a : int, b : int) =&gt; int { return a+b; }</code></td>
</tr>
<tr class="odd">
<td>型定義</td>
<td><code>type hoge : {x : int, y : int};</code></td>
</tr>
</tbody>
</table>
<p>プログラムのトップレベルには、グローバル変数定義、関数定義、型定義が並びます。</p>
<pre><code>program  =
 | gvar_def = &quot;var&quot;  ident &quot;:&quot; type &quot;;&quot;
 | func_def = &quot;func&quot; ident &quot;:&quot; type compound
 | type_def = &quot;type&quot; ident &quot;:&quot; type &quot;;&quot;</code></pre>
<h3 id="文">文</h3>
<p>関数定義には複文 (compound satements) が続き、 その中には文 (statement) が並びます。</p>
<pre><code>compound = &quot;{&quot; stmt* &quot;}&quot;

stmt =
空文
 | void_stmt = &quot;;&quot;
複文
 | compound  = &quot;{&quot; stmt* &quot;}&quot;
式文
 | expr_stmt = expr &quot;;&quot;
ローカル変数定義
 | lvar_def  = &quot;var&quot; ident &quot;:&quot; type &quot;;&quot;
代入文
 | assign    = expr &quot;=&quot; expr &quot;;&quot;
制御文
 | if        = &quot;if&quot; &quot;(&quot; expr &quot;)&quot; stmt
 | if_else   = &quot;if&quot; &quot;(&quot; expr &quot;)&quot; stmt &quot;else&quot; stmt
 | goto      = &quot;goto&quot; ident &quot;;&quot;
 | label     = ident &quot;:&quot;
 | return    = &quot;return&quot; expr &quot;;&quot;
繰り返し文
 | while     = &quot;while&quot; &quot;(&quot; expr &quot;)&quot; stmt
 | continue  = &quot;continue&quot; &quot;;&quot;
 | break     = &quot;break&quot; &quot;;&quot;</code></pre>
<h4 id="式文">式文</h4>
<p>式を評価します。評価値は破棄されるため、実用上は副作用を実行するための文です。</p>
<h4 id="代入文">代入文</h4>
<p>代入文が変数の値を書き換える唯一の方法です。</p>
<p>左辺はアドレス、右辺は値として評価できる必要があります。</p>
<p><code>a : int = b : int</code></p>
<p>という代入文は、実際には、</p>
<p><code>a@ : *int &lt;= b : int</code></p>
<p>このような動作をしています。</p>
<h4 id="goto-label">goto label</h4>
<p>関数呼び出しのABIを守るため、gotoは同一の関数内である必要がある。</p>
<p>ラベルの前に関数名を付記することで <code>&lt;func-name&gt;_&lt;label-name&gt;</code> 、 関数外へのgotoはアセンブラがエラーを出す。</p>
<p>アドホックですが、gotoはそんなに使わないのでこの程度のエラー処理でいいでしょう。</p>
<pre><code>func main : ()=&gt;int {
  goto hoge; //     jump zero zero main_hoge
hoge:      // main_hoge:
}</code></pre>
<h3 id="式">式</h3>
<h4 id="演算">演算</h4>
<pre><code>expr = cond = or (&quot;?&quot; expr &quot;:&quot; cond)?
or  = xor (&quot;|&quot; xor)*
xor = and (&quot;^&quot; and)*
and = equal (&quot;&amp;&quot; equal)*
equal = relat (&quot;==&quot; relat | &quot;!=&quot; relat)*
relat = shift (&quot;&lt;&quot; shift | &quot;&lt;=&quot; shift | &quot;&gt;&quot; shift | &quot;&gt;=&quot; shift)*
shift = (shift &quot;&lt;&lt;&quot; | shift &quot;&gt;&gt;&quot;)? add
add   = mul (&quot;+&quot; mul | &quot;-&quot; mul)*
mul   = prim (&quot;**&quot; prim | &quot;//&quot; prim | &quot;%%&quot; prim)*</code></pre>
<h4 id="後置演算子">後置演算子</h4>
<pre><code>post =
 | prim
 | cast      = post &quot;:&quot; type
 | ref       = post &quot;*&quot;
 | addr      = post &quot;@&quot;
 | array     = post &quot;[&quot; expr &quot;]&quot; 
 | member    = post &quot;.&quot; ident
 | func_call = post &quot;(&quot; expr % &quot;,&quot; )&quot;</code></pre>
<h3 id="値">値</h3>
<pre><code>prim =
 | num
 | ident
 | &quot;(&quot; expr &quot;)&quot;
 | &quot;&lt;&quot; type &quot;&gt;&quot; // sizeof</code></pre>
<h2 id="コンパイラの動作">コンパイラの動作</h2>
<h3 id="トークン化">トークン化</h3>
<p>文字列をトークン列に変換します。</p>
<ul>
<li>コメントの除去</li>
<li>文字列リテラル</li>
</ul>
<h3 id="抽象構文木の構築">抽象構文木の構築</h3>
<p>抽象構文木 (Abstract Syntax Tree : AST) は構造化されたソースコードです。</p>
<table>
<thead>
<tr class="header">
<th>Func</th>
<th><code>Node::Type</code></th>
<th><code>childs</code></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>type</td>
<td>TypeFunc</td>
<td>arg[]</td>
<td>ret</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>TypeStruct</td>
<td>member[]</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>TypeArray</td>
<td>base</td>
<td>size</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>TypePointer</td>
<td>base</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>TypePrim</td>
<td>ident</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>program</td>
<td>Program</td>
<td>defs</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>FuncDef</td>
<td>name</td>
<td>type</td>
<td>compound</td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>GVarDef</td>
<td>name</td>
<td>type</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>TypeDef</td>
<td>name</td>
<td>type</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>compound</td>
<td>Compound</td>
<td>stmt[]</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>stmt</td>
<td>VoidStmt</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>ExprStmt</td>
<td>expr</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>LVarDef</td>
<td>name</td>
<td>type</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>Assign</td>
<td>expr</td>
<td>expr</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>UAssign</td>
<td>expr</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>If</td>
<td>cond</td>
<td>true_node</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>IfElse</td>
<td>cond</td>
<td>true_node</td>
<td>false_node</td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>Goto</td>
<td>name</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>Label</td>
<td>name</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>Return</td>
<td>expr</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>While</td>
<td>cond</td>
<td>body</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>DoWhile</td>
<td>cond</td>
<td>body</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>For</td>
<td>cond</td>
<td>body</td>
<td>init</td>
<td>iterate</td>
</tr>
<tr class="even">
<td></td>
<td>Continue</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>Break</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td><strong>expr</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>cond</td>
<td>Cond</td>
<td>cond</td>
<td>true_node</td>
<td>false_node</td>
<td></td>
</tr>
<tr class="even">
<td>or</td>
<td>Or</td>
<td>:</td>
<td>:</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>xor</td>
<td>Xor</td>
<td>:</td>
<td>:</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>and</td>
<td>And</td>
<td>:</td>
<td>:</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>equality</td>
<td>EQ</td>
<td>:</td>
<td>:</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>NEQ</td>
<td>:</td>
<td>:</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>relational</td>
<td>LT</td>
<td>:</td>
<td>:</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>LEQ</td>
<td>:</td>
<td>:</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>GT</td>
<td>:</td>
<td>:</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>GEQ</td>
<td>:</td>
<td>:</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>shift</td>
<td>RShift</td>
<td>:</td>
<td>:</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>LShift</td>
<td>:</td>
<td>:</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>add</td>
<td>Add</td>
<td>:</td>
<td>:</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>Sub</td>
<td>:</td>
<td>:</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>mul</td>
<td>Mul</td>
<td>:</td>
<td>:</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>Div</td>
<td>:</td>
<td>:</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>Mod</td>
<td>:</td>
<td>:</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>post</td>
<td>Cast</td>
<td>ident</td>
<td>type</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>Ref</td>
<td>ident</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>Addr</td>
<td>ident</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>Array</td>
<td>ident</td>
<td>expr</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>Member</td>
<td>ident</td>
<td>ident</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>FuncCall</td>
<td>ident</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>prim</td>
<td>Num</td>
<td><strong><em>int</em></strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>Ident</td>
<td><strong><em>str</em></strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>SizeOf</td>
<td>type</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="シンボルテーブル生成">シンボルテーブル生成</h3>
<table>
<thead>
<tr class="header">
<th>種類</th>
<th>名前</th>
<th>型</th>
<th>アドレス</th>
<th>関数本体</th>
<th>ローカル</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Func</td>
<td>name</td>
<td>type</td>
<td>addr (テキスト領域)</td>
<td>body</td>
<td>lsymbol</td>
</tr>
<tr class="even">
<td>GVar</td>
<td>name</td>
<td>type</td>
<td>addr (静的領域)</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>LVar</td>
<td>name</td>
<td>type</td>
<td>addr (スタック相対)</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>Type</td>
<td>name</td>
<td>type</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="astの再帰的評価">ASTの再帰的評価</h3>
<p>ASTの部分木を再帰的に評価することで、コード生成に必要なさまざまな情報を得ることができます。</p>
<h4 id="型のサイズ">型のサイズ</h4>
<p>変数に必要なメモリを知るために型のサイズを計算します。</p>
<ul>
<li>整数型 : 1 (16bit)</li>
<li>ポインタ型 : 1 (16bit)</li>
<li>配列型 : ベース型の N 倍</li>
<li>構造体型 : メンバのサイズの合計</li>
<li>関数型 : 直接評価不可</li>
</ul>
<h4 id="変数">変数</h4>
<h4 id="アドレス">アドレス</h4>
<p>代入文の左辺を評価します。</p>
<h4 id="定数値">定数値</h4>
<p>コンパイル時に値が決まっているべき部分を評価します。</p>
<h3 id="アセンブラコードの生成">アセンブラコードの生成</h3>
<h3 id="グローバル変数の配置">グローバル変数の配置</h3>
<p>グローバル変数はデータ領域に配置されます。</p>
<h3 id="関数のコード生成">関数のコード生成</h3>
<h4 id="実行環境メモ">実行環境メモ</h4>
<p>現在の位置を保持しながらコード生成をする。</p>
<table>
<thead>
<tr class="header">
<th>関数</th>
<th>ループ</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>main</td>
<td>null / for_1 / for_1</td>
</tr>
</tbody>
</table>
<p>return, break, continue に必要な情報。</p>
<p>関数のバイナリはテキスト領域に配置されます。</p>
<p>低レイヤの世界では「テキスト」は実行可能なバイナリのことを指します。</p>
<h4 id="ローカル変数の配置">ローカル変数の配置</h4>
<p>スタックのアドレスはフレームポインタからの相対アドレスです。</p>
<h2 id="作業日誌">作業日誌</h2>
<ul>
<li>11/10
<ul>
<li>四則演算の実装
<ul>
<li>構文木構築</li>
<li>再帰的評価</li>
</ul></li>
</ul></li>
</ul>
<pre><code>expr =  mul (&quot;+&quot; mul | &quot;-&quot; mul)*
mul = primary (&quot;*&quot; primary | &quot;/&quot; primary | &quot;%&quot; primary)*
primary = num | &quot;(&quot; expr &quot;)&quot;</code></pre>
<ul>
<li>11/13
<ul>
<li>演算子の拡張
<ul>
<li>? :, ||, &amp;&amp;, |, ^, &amp;, ==, !=, &lt;, &lt;=, &gt;, &gt;=, &lt;&lt;, &gt;&gt;, *, /, %, ++, –</li>
</ul></li>
</ul></li>
<li>11/15
<ul>
<li>変数の実装</li>
</ul></li>
</ul>
<pre><code>prim = num | ident | &quot;(&quot; expr &quot;)&quot;</code></pre>
<ul>
<li>11/16
<ul>
<li>文の実装</li>
<li>代入の実装</li>
</ul></li>
</ul>
<pre><code>program = stmt*
stmt = &quot;;&quot;
     | &quot;{&quot; stmt* &quot;}&quot;
     | &quot;if&quot; &quot;(&quot; expr &quot;)&quot; stmt (&quot;else&quot; stmt)?
     | &quot;while&quot; &quot;(&quot; expr &quot;)&quot; stmt
     | &quot;do&quot; stmt &quot;while&quot; ( expr ) &quot;;&quot;
     | &quot;for&quot; &quot;(&quot; expr? &quot;;&quot; expr? &quot;;&quot; expr? &quot;)&quot; stmt
     | expr &quot;;&quot;</code></pre>
<ul>
<li>2/8
<ul>
<li>関数定義</li>
</ul></li>
</ul>
<pre><code>program = func*
func = ident &quot;(&quot; ident % &quot;,&quot; &quot;)&quot; compound
compound = &quot;{&quot; stmt* &quot;}&quot;</code></pre>
<ul>
<li>2/9
<ul>
<li>型</li>
</ul></li>
<li>2/10
<ul>
<li>AST ノードの改良
<ul>
<li>child を vector にまとめメソッドでアクセスするようにした</li>
</ul></li>
</ul></li>
<li>2/12
<ul>
<li>変数定義</li>
</ul></li>
<li>2/14
<ul>
<li>細かい文法を決めた</li>
<li>ドキュメントの整備</li>
</ul></li>
<li>2/15
<ul>
<li>AST完成？</li>
<li>ポインタの*と乗算の*、アドレスの&amp;と論理積の&amp;の区別がつかない
<ul>
<li>残された記号は @ と $</li>
<li>論理演算とビット演算は同じにできるか？</li>
<li>アドレス演算子は@でいいかも。アドレスっぽいし</li>
<li>乗除算は**と//にする
<ul>
<li>乗除算器を持たないので重いよという意味で</li>
</ul></li>
</ul></li>
<li>文法を↑で変える。暫定的</li>
</ul></li>
<li>2/16
<ul>
<li>↑アホか？ポインタのポインタと競合するやんけ。</li>
</ul></li>
<li>2/17
<ul>
<li>DFS、シンボルテーブルができた</li>
<li>シンボル、ローカルとグローバルを統一したいわね</li>
<li>Static変数も作りたい</li>
</ul></li>
<li>2/20</li>
</ul>
<h2 id="参考">参考</h2>
<p>https://github.com/DoctorWkt/acwj</p>
<p>https://github.com/rui314/chibicc</p>
<p>https://www.sigbus.info/compilerbook</p>
<p>https://github.com/season1618/books/blob/main/c-compiler/index.md</p>

    <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="126.444 2.281 589 589"
      style="margin: auto; padding: 0; display: block" onclick="tweet();">
      <circle cx="420.944" cy="296.781" r="294.5" fill="#2daae1" />
      <path
        d="M609.773 179.634c-13.891 6.164-28.811 10.331-44.498 12.204 16.01-9.587 28.275-24.779 34.066-42.86a154.78 154.78 0 0 1-49.209 18.801c-14.125-15.056-34.267-24.456-56.551-24.456-42.773 0-77.462 34.675-77.462 77.473 0 6.064.683 11.98 1.996 17.66-64.389-3.236-121.474-34.079-159.684-80.945-6.672 11.446-10.491 24.754-10.491 38.953 0 26.875 13.679 50.587 34.464 64.477a77.122 77.122 0 0 1-35.097-9.686v.979c0 37.54 26.701 68.842 62.145 75.961-6.511 1.784-13.344 2.716-20.413 2.716-4.998 0-9.847-.473-14.584-1.364 9.859 30.769 38.471 53.166 72.363 53.799-26.515 20.785-59.925 33.175-96.212 33.175-6.25 0-12.427-.373-18.491-1.104 34.291 21.988 75.006 34.824 118.759 34.824 142.496 0 220.428-118.052 220.428-220.428 0-3.361-.074-6.697-.236-10.021a157.855 157.855 0 0 0 38.707-40.158z"
        fill="#fff" />
    </svg>
  </article>
</body>

</html>