<!-- (ฅ^･ω･^ฅ) ﾆｬｰ -->

<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja" prefix="og: http://ogp.me/ns#">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-114187773-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag("js", new Date());
    gtag("config", "UA-114187773-1");
  </script>
  <!-- End Google Analytics -->
  <!-- Load Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap" rel="stylesheet">
  <!-- End Google Font -->

  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="@kanade_k_1228" />
  <link rel="shortcut icon" href="https://avatars.githubusercontent.com/u/54773334" />
      <title>アセンブラ | Kanade's Website</title>

  <!-- OGP -->
    <!-- END OGP -->
  <link rel="stylesheet" href="https://kanade-k-1228.github.io/common/style.css" />
    <script type="text/javascript" id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <style>
    mjx-container[jax="CHTML"][display="true"] {
      display: block;
      text-align: center;
      margin: 0;
    }
  </style>
  <!-- SyntaxHighlight -->
  <link rel="stylesheet" href="https://kanade-k-1228.github.io/common/highlight.css" />
  <script src="https://kanade-k-1228.github.io/common/highlight.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
  </script>

  <script>
    function tweet() {
      window.open(
        "https://twitter.com/intent/tweet?via=kanade_k_1228&related=kanade_k_1228&url=" +
        location.href +
        "&text=" +
        "アセンブラ",
        "_blank"
      );
    }
  </script>
</head>

<body>
  <article>
    <header>
      <ul>
        <li><a href="/">ﾎｰﾑ</a></li>
        <li><a href="/Portfolio/">ﾎﾟﾄﾌｫﾘｵ</a></li>
        <li><a href="/Lab/">研究室</a></li>
        <li><a href="/Blog/">雑記</a></li>
      </ul>
      <div id="header-links">
        <a href="https://twitter.com/kanade_k_1228" target="_blank">
          <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="126.444 2.281 589 589"
            style="margin: 0; padding: 0">
            <circle cx="420.944" cy="296.781" r="294.5" fill="#2daae1" />
            <path
              d="M609.773 179.634c-13.891 6.164-28.811 10.331-44.498 12.204 16.01-9.587 28.275-24.779 34.066-42.86a154.78 154.78 0 0 1-49.209 18.801c-14.125-15.056-34.267-24.456-56.551-24.456-42.773 0-77.462 34.675-77.462 77.473 0 6.064.683 11.98 1.996 17.66-64.389-3.236-121.474-34.079-159.684-80.945-6.672 11.446-10.491 24.754-10.491 38.953 0 26.875 13.679 50.587 34.464 64.477a77.122 77.122 0 0 1-35.097-9.686v.979c0 37.54 26.701 68.842 62.145 75.961-6.511 1.784-13.344 2.716-20.413 2.716-4.998 0-9.847-.473-14.584-1.364 9.859 30.769 38.471 53.166 72.363 53.799-26.515 20.785-59.925 33.175-96.212 33.175-6.25 0-12.427-.373-18.491-1.104 34.291 21.988 75.006 34.824 118.759 34.824 142.496 0 220.428-118.052 220.428-220.428 0-3.361-.074-6.697-.236-10.021a157.855 157.855 0 0 0 38.707-40.158z"
              fill="#fff" />
          </svg>
        </a>
        <a href="https://github.com/kanade-k-1228" target="_blank">
          <svg width="50px" height="50px" viewBox="0 0 1024 1024" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" clip-rule="evenodd"
              d="M8 0C3.58 0 0 3.58 0 8C0 11.54 2.29 14.53 5.47 15.59C5.87 15.66 6.02 15.42 6.02 15.21C6.02 15.02 6.01 14.39 6.01 13.72C4 14.09 3.48 13.23 3.32 12.78C3.23 12.55 2.84 11.84 2.5 11.65C2.22 11.5 1.82 11.13 2.49 11.12C3.12 11.11 3.57 11.7 3.72 11.94C4.44 13.15 5.59 12.81 6.05 12.6C6.12 12.08 6.33 11.73 6.56 11.53C4.78 11.33 2.92 10.64 2.92 7.58C2.92 6.71 3.23 5.99 3.74 5.43C3.66 5.23 3.38 4.41 3.82 3.31C3.82 3.31 4.49 3.1 6.02 4.13C6.66 3.95 7.34 3.86 8.02 3.86C8.7 3.86 9.38 3.95 10.02 4.13C11.55 3.09 12.22 3.31 12.22 3.31C12.66 4.41 12.38 5.23 12.3 5.43C12.81 5.99 13.12 6.7 13.12 7.58C13.12 10.65 11.25 11.33 9.47 11.53C9.76 11.78 10.01 12.26 10.01 13.01C10.01 14.08 10 14.94 10 15.21C10 15.42 10.15 15.67 10.55 15.59C13.71 14.53 16 11.53 16 8C16 3.58 12.42 0 8 0Z"
              transform="scale(64)" fill="#1B1F23" />
          </svg>
        </a>
        <a href="https://t.co/E5xtfEQs4A" target="_blank">
          <img src="http://kanade-k-1228.github.io/img/niconico.png" width="50px" height="50px"
            style="border-radius: 50%" /></a>
        <a href="https://www.youtube.com/channel/UCoeuc9-XQ5EpeYSCn4ESpQw" target="_blank">
          <svg width="50px" height="50px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 333333 333333">
            <path
              d="M166667 0c92048 0 166667 74619 166667 166667s-74619 166667-166667 166667S0 258715 0 166667 74619 0 166667 0zm84195 132297s-1678-11849-6843-17052c-6545-6843-13873-6887-17223-7283-24036-1751-60138-1751-60138-1751h-63s-36085 0-60135 1751c-3363 409-10681 437-17223 7283-5168 5203-6811 17052-6811 17052s-1711 13904-1711 27838v13029c0 13905 1709 27837 1709 27837s1678 11849 6811 17061c6542 6843 15139 6621 18977 7350 13761 1314 58457 1710 58457 1710s36133-64 60169-1783c3363-397 10678-438 17223-7284 5168-5202 6843-17065 6843-17065s1711-13904 1711-27837v-13028c-35-13905-1745-27837-1745-27837l-9 9-1-1zm-102010 56674v-48312l46437 24237-46437 24075z"
              fill="red" />
          </svg>
        </a>
      </div>
      <!-- End Top Nav -->
      <!-- Title -->
            <h1 style="margin: 0">アセンブラ</h1>
            <!-- Date -->
            <!-- Description -->
          </header>

    <!-- TeX Macros -->
    <!-- prettier-ignore -->
    <p style="display: none">
      \[ \newcommand{dn}[3]{\frac{\mathrm{d}^{#3} #1}{\mathrm{d} #2^{#3}}}
      \newcommand{\d}[2]{\frac{\mathrm{d} #1}{\mathrm{d} #2}}
      \newcommand{\dd}[2]{\frac{\mathrm{d}^2 #1}{\mathrm{d} {#2}^2}}
      \newcommand{\ddd}[2]{\frac{\mathrm{d}^3 #1}{\mathrm{d} {#2}^3}}
      \newcommand{\pdn}[3]{\frac{\partial^{#3} #1}{\partial {#2}^{#3}}}
      \newcommand{\pd}[2]{\frac{\partial #1}{\partial #2}}
      \newcommand{\pdd}[2]{\frac{\partial^2 #1}{\partial {#2}^2}}
      \newcommand{\pddd}[2]{\frac{\partial^3 #1}{\partial {#2}^3}}
      \newcommand{\p}{\partial}
      \newcommand{\D}[2]{\frac{\mathrm{D} #1}{\mathrm{D} #2}}
      \newcommand{\Re}{\mathrm{Re}}
      \newcommand{\Im}{\mathrm{Im}}
      \newcommand{\bra}[1]{\left\langle #1 \right|}
      \newcommand{\ket}[1]{\left|#1 \right\rangle}
      \newcommand{\braket}[2]{\left\langle #1 \middle|#2 \right\rangle}
      \newcommand{\inner}[2]{\left\langle #1 ,#2 \right\rangle}
      \newcommand{\l}{\left} \newcommand{\m}{\middle} \newcommand{\r}{\right}
      \newcommand{\f}[2]{\frac{#1}{#2}} \newcommand{\eps}{\varepsilon}
      \newcommand{\ra}{\rightarrow} \newcommand{\F}{\mathcal{F}}
      \newcommand{\L}{\mathcal{L}} \newcommand{\t}{\quad}
      \newcommand{\intinf}{\int_{-\infty}^{+\infty}}
      \newcommand{\R}{\mathcal{R}} \newcommand{\C}{\mathcal{C}}
      \newcommand{\Z}{\mathcal{Z}} \newcommand{\bm}[1]{\boldsymbol{#1}} \]
    </p>

    <!-- Table of Contents -->
        <nav><ul>
<li><a href="#命令一覧">命令一覧</a></li>
<li><a href="#命令変数定数のラベル">命令・変数・定数のラベル</a></li>
<li><a href="#アセンブラの実装">アセンブラの実装</a></li>
<li><a href="#慣用句">慣用句</a>
<ul>
<li><a href="#サブルーチン">サブルーチン</a></li>
<li><a href="#割り込み処理">割り込み処理</a></li>
</ul></li>
</ul></nav>
     <h2 id="命令一覧">命令一覧</h2>
<table>
<thead>
<tr class="header">
<th>命令</th>
<th>アセンブリ</th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>レジスタ演算</td>
<td>add rd rs1 rs2</td>
<td>rd = rs1 + rs2</td>
</tr>
<tr class="even">
<td>即値演算</td>
<td>addi rd rs1 imm</td>
<td>rd = rs1 + imm</td>
</tr>
<tr class="odd">
<td>ロード</td>
<td>load rd rs1 imm</td>
<td>rd = mem[rs1 + imm]</td>
</tr>
<tr class="even">
<td>ストア</td>
<td>store rs1 rs2 imm</td>
<td>mem[rs1 + imm] = rs2</td>
</tr>
<tr class="odd">
<td>即値ロード</td>
<td>loadi rd imm</td>
<td>rd = imm</td>
</tr>
<tr class="even">
<td>ジャンプ</td>
<td>jump rd rs1 imm</td>
<td>rd = PC + 1, PC = rs1 + imm</td>
</tr>
<tr class="odd">
<td>条件分岐（＝）</td>
<td>breq rs1 rs2 imm</td>
<td>if(rs1 = rs2) PC = imm</td>
</tr>
<tr class="even">
<td>条件分岐（＜）</td>
<td>brlt rs1 rs2 imm</td>
<td>if(rs1 &lt; rs2) PC = imm</td>
</tr>
</tbody>
</table>
<h2 id="命令変数定数のラベル">命令・変数・定数のラベル</h2>
<p>一般的なアセンブラには、ラベルというものがあります。</p>
<pre><code>   jump label
~~~
label:
   addi s0 s0 4</code></pre>
<p>プログラム中のある命令を指定します。</p>
<pre><code>0x0010:
0x0011: 0x</code></pre>
<p>この機能を拡張して、変数と定数を定義できるようにします。</p>
<pre><code>@0xf010 hoge
#0x0334 hanshin</code></pre>
<p>ちょっと機能を追加して、アセンブリのコーディングが楽になるようにします。</p>
<h2 id="アセンブラの実装">アセンブラの実装</h2>
<ol type="1">
<li>一行づつ読み取る
<ol type="1">
<li>コメント、空行を削除</li>
<li>一語目を読む
<ol type="1">
<li>命令の場合
<ol type="1">
<li>命令の引数の型に従い、続く語を読む</li>
<li>引数にラベルがある場合、ラベルを記録して保留</li>
</ol></li>
<li>ラベルの場合
<ol type="1">
<li>ラベルの辞書に、ラベルの指すアドレスを記録</li>
</ol></li>
</ol></li>
</ol></li>
<li>ラベルの置換（リロケーション</li>
<li>バイナリを出力</li>
</ol>
<h2 id="慣用句">慣用句</h2>
<h3 id="サブルーチン">サブルーチン</h3>
<p><a href="https://inst.eecs.berkeley.edu/~cs61c/resources/RISCV_Calling_Convention.pdf">参考</a></p>
<table>
<thead>
<tr class="header">
<th>RKASM</th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>subi sp sp 5</td>
<td>スタックポインタを減算し、スタックを確保</td>
</tr>
<tr class="even">
<td>store s0 sp 0</td>
<td>レジスタをスタックに退避</td>
</tr>
<tr class="odd">
<td>store s1 sp 1</td>
<td></td>
</tr>
<tr class="even">
<td>store s1 sp 2</td>
<td></td>
</tr>
<tr class="odd">
<td>store s1 sp 3</td>
<td></td>
</tr>
<tr class="even">
<td>store ra sp 4</td>
<td>リターンアドレスも退避</td>
</tr>
<tr class="odd">
<td>loadi a0 334</td>
<td>引数をレジスタにセット</td>
</tr>
<tr class="even">
<td>loadi a1 2</td>
<td>※ 引数レジスタが足りなければスタックにセット</td>
</tr>
<tr class="odd">
<td>jump ra func</td>
<td>サブルーチンにジャンプ</td>
</tr>
<tr class="even">
<td></td>
<td>ここに戻ってくる</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
</tr>
<tr class="even">
<td>func:</td>
<td></td>
</tr>
<tr class="odd">
<td>—</td>
<td>サブルーチンの処理</td>
</tr>
<tr class="even">
<td>—</td>
<td></td>
</tr>
<tr class="odd">
<td>l ra sp 0</td>
<td>レジスタを復元</td>
</tr>
<tr class="even">
<td>l ra sp 1</td>
<td></td>
</tr>
<tr class="odd">
<td>l ra sp 2</td>
<td></td>
</tr>
<tr class="even">
<td>l ra sp 3</td>
<td></td>
</tr>
<tr class="odd">
<td>l ra sp 4</td>
<td>リターンアドレスを復元</td>
</tr>
<tr class="even">
<td>addi sp sp 5</td>
<td>スタックポインタを加算</td>
</tr>
<tr class="odd">
<td>jump zero ra 0</td>
<td>PC を戻す</td>
</tr>
</tbody>
</table>
<h3 id="割り込み処理">割り込み処理</h3>
<table>
<thead>
<tr class="header">
<th>ASM</th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>subi sp 16</td>
<td>全てのレジスタをスタックに退避</td>
</tr>
<tr class="even">
<td>s x1 sp 0</td>
<td></td>
</tr>
<tr class="odd">
<td>:</td>
<td></td>
</tr>
<tr class="even">
<td>s x15 sp 14</td>
<td></td>
</tr>
<tr class="odd">
<td>j ra xxxx</td>
<td>ジャンプ</td>
</tr>
<tr class="even">
<td>:</td>
<td></td>
</tr>
<tr class="odd">
<td>:</td>
<td>割り込み処理を行う</td>
</tr>
<tr class="even">
<td>:</td>
<td></td>
</tr>
<tr class="odd">
<td>l x1 sp 0</td>
<td>レジスタを復元</td>
</tr>
<tr class="even">
<td>:</td>
<td></td>
</tr>
<tr class="odd">
<td>l x15 sp 14</td>
<td></td>
</tr>
<tr class="even">
<td>jr ra 0</td>
<td>PC を戻す</td>
</tr>
</tbody>
</table>

    <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="126.444 2.281 589 589"
      style="margin: auto; padding: 0; display: block" onclick="tweet();">
      <circle cx="420.944" cy="296.781" r="294.5" fill="#2daae1" />
      <path
        d="M609.773 179.634c-13.891 6.164-28.811 10.331-44.498 12.204 16.01-9.587 28.275-24.779 34.066-42.86a154.78 154.78 0 0 1-49.209 18.801c-14.125-15.056-34.267-24.456-56.551-24.456-42.773 0-77.462 34.675-77.462 77.473 0 6.064.683 11.98 1.996 17.66-64.389-3.236-121.474-34.079-159.684-80.945-6.672 11.446-10.491 24.754-10.491 38.953 0 26.875 13.679 50.587 34.464 64.477a77.122 77.122 0 0 1-35.097-9.686v.979c0 37.54 26.701 68.842 62.145 75.961-6.511 1.784-13.344 2.716-20.413 2.716-4.998 0-9.847-.473-14.584-1.364 9.859 30.769 38.471 53.166 72.363 53.799-26.515 20.785-59.925 33.175-96.212 33.175-6.25 0-12.427-.373-18.491-1.104 34.291 21.988 75.006 34.824 118.759 34.824 142.496 0 220.428-118.052 220.428-220.428 0-3.361-.074-6.697-.236-10.021a157.855 157.855 0 0 0 38.707-40.158z"
        fill="#fff" />
    </svg>
  </article>
</body>

</html>