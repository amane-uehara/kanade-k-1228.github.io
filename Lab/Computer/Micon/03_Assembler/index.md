---
title: アセンブラ
---

## アセンブラ

1. 一行読み取る
2. フォーマットに当てはめる
   1. フォーマットを読み取って、バイナリを出力する
      1. フォーマットエラー（誤った命令名、オペランド不足・超過）
   2. ラベルがオペランドに見つかった場合
      1. ラベルのリストに、ラベル名とバイナリ上の位置を追加
   3. ラベルの本体が見つかった場合
      1. ラベルの辞書に、ラベル名とリンク先を追加
         1. 既に存在するラベルの場合、ラベル重複エラー
3. EOF に到達
4. ラベルのリストをもとにバイナリ中のラベルの書き込み位置を探し、ラベルの値を書き込む。

## 慣用句

### サブルーチン

[参考](https://inst.eecs.berkeley.edu/~cs61c/resources/RISCV_Calling_Convention.pdf)

| ASM          |                                          |
| ------------ | ---------------------------------------- |
| subi sp sp 5 | スタックポインタを減算し、スタックを確保 |
| s s0 sp 0    | レジスタをスタックに退避                 |
| s s1 sp 1    |                                          |
| s s1 sp 2    |                                          |
| s s1 sp 3    |                                          |
| s ra sp 4    | リターンアドレスも退避                   |
| li a0 334    | 引数をレジスタにセット                   |
|              | レジスタが足りなければスタックにセット   |
| j ra f       | サブルーチンにジャンプ                   |
| f:           |                                          |
| ---          | サブルーチンの処理                       |
| ---          |                                          |
| l ra sp 0    | レジスタを復元                           |
| l ra sp 1    |                                          |
| l ra sp 2    |                                          |
| l ra sp 3    |                                          |
| l ra sp 4    | リターンアドレスを復元                   |
| addi sp sp 5 | スタックポインタを加算                   |
| jr ra 0      | PC を戻す                                |

### 割り込み処理

| ASM         |                                |
| ----------- | ------------------------------ |
| subi sp 16  | 全てのレジスタをスタックに退避 |
| s x1 sp 0   |                                |
| :           |                                |
| s x15 sp 14 |                                |
| j ra xxxx   | ジャンプ                       |
| :           |                                |
| :           | 割り込み処理を行う             |
| :           |                                |
| l x1 sp 0   | レジスタを復元                 |
| :           |                                |
| l x15 sp 14 |                                |
| jr ra 0     | PC を戻す                      |
