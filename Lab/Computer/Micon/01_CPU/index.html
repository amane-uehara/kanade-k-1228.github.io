<!DOCTYPE html>
<html
  xmlns="http://www.w3.org/1999/xhtml"
  lang="ja"
  xml:lang="ja"
  prefix="og: http://ogp.me/ns#"
>
  <head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=UA-114187773-1"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "UA-114187773-1");
    </script>
    <!-- End Google Analytics -->
    <meta charset="utf-8" />
    <meta name="generator" content="pandoc" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=yes"
    />
    <meta name="author" content="@kanade_k_1228" />
    <link
      rel="shortcut icon"
      href="https://avatars.githubusercontent.com/u/54773334"
    />
        <meta name="dcterms.date" content="2022-09-27" />
          <title>自作マイコン用CPU、RISC-K | Kanade's Website</title>

    <!-- OGP -->
        <!-- END OGP -->

    <style>
      body {
        margin: 0;
        /* background-color: #fcfeff; */
        /* background-color: #e4f0fc; */
        background-color: #f0f8ff;
        font-size: 16px;
        font-family: メイリオ, Meiryo, 游ゴシック体, "Yu Gothic", YuGothic,
          "ヒラギノ角ゴシック Pro", "Hiragino Kaku Gothic Pro", Osaka,
          "ＭＳ Ｐゴシック", "MS PGothic", sans-serif;
        line-height: 1.5;
        color: #202020;
      }
      article {
        display: block;
        margin: 0 auto;
      }
      @media (min-width: 1220px) {
        article {
          width: 1200px;
        }
      }
      @media (max-width: 1219px) {
        article {
          width: 100%;
        }
      }
      h1 {
        display: block;
        margin: 0.5em 0 0.5em 0;
        padding: 8px;
        color: #d64acf;
        font-size: 25px;
        font-weight: bold;
        background-color: #ffccff;
      }
      h2 {
        display: block;
        margin: 0.5em 0 0.5em 0;
        padding: 8px;
        color: #2c8ecf;
        font-size: 20px;
        font-weight: bold;
        background: #bbddff;
      }
      h3 {
        font-weight: bold;
        margin: 1em 0 0.5em 0.5em;
      }
      h4 {
        font-weight: bold;
        margin: 0.5em 0 0.5em 0.7em;
      }
      p {
        margin: 0.5em 0 0.5em 1em;
      }
      small {
        font-size: 10px;
      }
      table {
        margin: 0.5em auto;
        border-collapse: collapse;
      }
      th {
        border: 1px solid;
        padding: 0.3em;
        text-align: center;
        background-color: #e8ffbd;
      }
      td {
        border: 1px solid;
        padding: 0.3em;
        text-align: center;
        background-color: #f0f0ff;
      }
      ul,
      ol {
        margin: 0.5em 0 0.5em 1em;
        padding: 0 0 0 1.5em;
      }
      ul ul,
      ul ul ul,
      ol ol,
      ol ol ol {
        margin: 0;
      }
      blockquote {
        border: 1px solid;
        border-radius: 2px;
        background-color: white;
        margin: 0.5em 1em 0.5em 1em;
      }
      img {
        display: block;
        margin: 0 auto;
        max-width: 100%;
        min-width: 50%;
      }
      header > ul {
        margin: 0.5em 0 0.5em 0;
        padding: 0;
        list-style: none;
        display: flex;
        flex-direction: row;
      }
      header > ul > li {
        width: 25%;
        text-align: center;
      }
      header > ul > li > a {
        display: block;
      }
      div#header-links {
        height: 50px;
        display: flex;
        margin: 0.5em 0 0.5em 0;
        justify-content: space-evenly;
      }
      div#header-links > a {
        text-decoration: none;
      }
      nav {
        border: 1px solid;
        border-radius: 2px;
        background-color: white;
        margin: 0.5em 1em 0.5em 1em;
      }
      nav > ul {
        margin: 0;
      }
      button {
        display: block;
        margin: 0.5em auto;
      }
      iframe {
        display: block;
        margin: 0.5em auto;
      }
      code {
        display: inline-block;
        padding: 1px;
        border: solid;
        border-width: 1px;
        border-radius: 5px;
        background: #ffffff;
      }
    </style>
    <style>
      a.sourceLine {
        display: inline-block;
        line-height: 1.25;
      }
      a.sourceLine {
        pointer-events: none;
        color: inherit;
        text-decoration: inherit;
      }
      a.sourceLine:empty {
        height: 1.2em;
      }
      .sourceCode {
        overflow: visible;
        font-family: Consolas, Menlo, "Liberation Mono", Courier, monospace;
      }
      code.sourceCode {
        white-space: pre;
        position: relative;
      }
      div.sourceCode {
        margin: 0.5em 1em 0.5em 1em;
      }
      pre.sourceCode {
        margin: 0;
      }
      @media screen {
        div.sourceCode {
          overflow: auto;
        }
      }
      @media print {
        code.sourceCode {
          white-space: pre-wrap;
        }
        a.sourceLine {
          text-indent: -1em;
          padding-left: 1em;
        }
      }
      pre.numberSource a.sourceLine {
        position: relative;
        left: -4em;
      }
      pre.numberSource a.sourceLine::before {
        content: attr(title);
        position: relative;
        left: -1em;
        text-align: right;
        vertical-align: baseline;
        border: none;
        pointer-events: all;
        display: inline-block;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        padding: 0 4px;
        width: 4em;
        color: #aaaaaa;
      }
      pre.numberSource {
        margin-left: 3em;
        border-left: 1px solid #aaaaaa;
        padding-left: 4px;
      }
      div.sourceCode {
        color: rgb(212, 212, 212);
        background-color: rgb(0, 0, 0);
      }
      @media screen {
        a.sourceLine::before {
          text-decoration: underline;
        }
      }
      code span.al {
        color: #ef2929;
      } /* Alert */
      code span.an {
        color: #8f5902;
        font-weight: bold;
        font-style: italic;
      } /* Annotation */
      code span.at {
        color: #c4a000;
      } /* Attribute */
      code span.bn {
        color: rgb(86, 156, 214);
      } /* BaseN */
      code span.cf {
        color: rgb(197, 134, 192);
        font-weight: bold;
      } /* ControlFlow */
      code span.ch {
        color: #4e9a06;
      } /* Char */
      code span.cn {
        color: rgb(181, 206, 168);
      } /* Constant */
      code span.co {
        color: rgb(106, 153, 85);
      } /* Comment */
      code span.cv {
        color: #8f5902;
        font-weight: bold;
        font-style: italic;
      } /* CommentVar */
      code span.do {
        color: #8f5902;
        font-weight: bold;
        font-style: italic;
      } /* Documentation */
      code span.dt {
        color: rgb(86, 156, 214);
      } /* DataType */
      code span.dv {
        color: rgb(181, 206, 168);
      } /* DecVal */
      code span.er {
        color: #a40000;
        font-weight: bold;
      } /* Error */
      code span.ex {
      } /* Extension */
      code span.fl {
        color: rgb(181, 206, 168);
      } /* Float */
      code span.fu {
        color: rgb(220, 220, 170);
      } /* Function */
      code span.im {
        color: rgb(206, 145, 120);
      } /* Import */
      code span.in {
        color: #8f5902;
        font-weight: bold;
        font-style: italic;
      } /* Information */
      code span.kw {
        color: rgb(78, 201, 176);
        font-weight: bold;
      } /* Keyword */
      code span.op {
      } /* Operator */
      code span.ot {
        color: #8f5902;
      } /* Other */
      code span.pp {
        color: rgb(197, 134, 192);
      } /* Preprocessor */
      code span.sc {
        color: rgb(215, 186, 125);
      } /* SpecialChar */
      code span.ss {
        color: #4e9a06;
      } /* SpecialString */
      code span.st {
        color: rgb(206, 145, 120);
      } /* String */
      code span.va {
        color: rgb(156, 220, 254);
      } /* Variable */
      code span.vs {
        color: #4e9a06;
      } /* VerbatimString */
      code span.wa {
        color: #8f5902;
        font-weight: bold;
        font-style: italic;
      } /* Warning */
    </style>
        <script
      type="text/javascript"
      id="MathJax-script"
      async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
    ></script>
    <style>
      mjx-container[jax="CHTML"][display="true"] {
        display: block;
        text-align: center;
        margin: 0;
      }
    </style>
    <!-- SyntaxHighlight -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/vs2015.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/highlight.min.js"></script>
    <script>
      hljs.initHighlightingOnLoad();
    </script>

    <script>
      function tweet() {
        window.open(
          "https://twitter.com/intent/tweet?via=kanade_k_1228&related=kanade_k_1228&url=" +
            location.href +
            "&text=" +
            "自作マイコン用CPU、RISC-K",
          "_blank"
        );
      }
    </script>
  </head>
  <body>
    <article>
      <header>
        <ul>
          <li><a href="/">ﾎｰﾑ</a></li>
          <li><a href="/Portfolio/">ﾎﾟﾄﾌｫﾘｵ</a></li>
          <li><a href="/Lab/">研究室</a></li>
          <li><a href="/Essay/">雑記</a></li>
        </ul>
        <div id="header-links">
          <a href="https://twitter.com/kanade_k_1228" target="_blank">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="50"
              height="50"
              viewBox="126.444 2.281 589 589"
              style="margin: 0; padding: 0"
            >
              <circle cx="420.944" cy="296.781" r="294.5" fill="#2daae1" />
              <path
                d="M609.773 179.634c-13.891 6.164-28.811 10.331-44.498 12.204 16.01-9.587 28.275-24.779 34.066-42.86a154.78 154.78 0 0 1-49.209 18.801c-14.125-15.056-34.267-24.456-56.551-24.456-42.773 0-77.462 34.675-77.462 77.473 0 6.064.683 11.98 1.996 17.66-64.389-3.236-121.474-34.079-159.684-80.945-6.672 11.446-10.491 24.754-10.491 38.953 0 26.875 13.679 50.587 34.464 64.477a77.122 77.122 0 0 1-35.097-9.686v.979c0 37.54 26.701 68.842 62.145 75.961-6.511 1.784-13.344 2.716-20.413 2.716-4.998 0-9.847-.473-14.584-1.364 9.859 30.769 38.471 53.166 72.363 53.799-26.515 20.785-59.925 33.175-96.212 33.175-6.25 0-12.427-.373-18.491-1.104 34.291 21.988 75.006 34.824 118.759 34.824 142.496 0 220.428-118.052 220.428-220.428 0-3.361-.074-6.697-.236-10.021a157.855 157.855 0 0 0 38.707-40.158z"
                fill="#fff"
              />
            </svg>
          </a>
          <a href="https://github.com/kanade-k-1228" target="_blank">
            <svg
              width="50px"
              height="50px"
              viewBox="0 0 1024 1024"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                fill-rule="evenodd"
                clip-rule="evenodd"
                d="M8 0C3.58 0 0 3.58 0 8C0 11.54 2.29 14.53 5.47 15.59C5.87 15.66 6.02 15.42 6.02 15.21C6.02 15.02 6.01 14.39 6.01 13.72C4 14.09 3.48 13.23 3.32 12.78C3.23 12.55 2.84 11.84 2.5 11.65C2.22 11.5 1.82 11.13 2.49 11.12C3.12 11.11 3.57 11.7 3.72 11.94C4.44 13.15 5.59 12.81 6.05 12.6C6.12 12.08 6.33 11.73 6.56 11.53C4.78 11.33 2.92 10.64 2.92 7.58C2.92 6.71 3.23 5.99 3.74 5.43C3.66 5.23 3.38 4.41 3.82 3.31C3.82 3.31 4.49 3.1 6.02 4.13C6.66 3.95 7.34 3.86 8.02 3.86C8.7 3.86 9.38 3.95 10.02 4.13C11.55 3.09 12.22 3.31 12.22 3.31C12.66 4.41 12.38 5.23 12.3 5.43C12.81 5.99 13.12 6.7 13.12 7.58C13.12 10.65 11.25 11.33 9.47 11.53C9.76 11.78 10.01 12.26 10.01 13.01C10.01 14.08 10 14.94 10 15.21C10 15.42 10.15 15.67 10.55 15.59C13.71 14.53 16 11.53 16 8C16 3.58 12.42 0 8 0Z"
                transform="scale(64)"
                fill="#1B1F23"
              />
            </svg>
          </a>
          <a href="https://t.co/E5xtfEQs4A" target="_blank">
            <img
              src="http://kanade-k-1228.github.io/img/niconico.png"
              width="50px"
              height="50px"
              style="border-radius: 50%"
          /></a>
          <a
            href="https://www.youtube.com/channel/UCoeuc9-XQ5EpeYSCn4ESpQw"
            target="_blank"
          >
            <svg
              width="50px"
              height="50px"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 333333 333333"
            >
              <path
                d="M166667 0c92048 0 166667 74619 166667 166667s-74619 166667-166667 166667S0 258715 0 166667 74619 0 166667 0zm84195 132297s-1678-11849-6843-17052c-6545-6843-13873-6887-17223-7283-24036-1751-60138-1751-60138-1751h-63s-36085 0-60135 1751c-3363 409-10681 437-17223 7283-5168 5203-6811 17052-6811 17052s-1711 13904-1711 27838v13029c0 13905 1709 27837 1709 27837s1678 11849 6811 17061c6542 6843 15139 6621 18977 7350 13761 1314 58457 1710 58457 1710s36133-64 60169-1783c3363-397 10678-438 17223-7284 5168-5202 6843-17065 6843-17065s1711-13904 1711-27837v-13028c-35-13905-1745-27837-1745-27837l-9 9-1-1zm-102010 56674v-48312l46437 24237-46437 24075z"
                fill="red"
              />
            </svg>
          </a>
        </div>
        <!-- End Top Nav -->
        <!-- Title -->
                <h1 style="margin: 0">自作マイコン用CPU、RISC-K</h1>
                <!-- Date -->
                <p align="right">2022-09-27</p>
                <!-- Description -->
              </header>

      <!-- TeX Macros -->
      <p style="display: none">
        \[ \newcommand{dn}[3]{\frac{\mathrm{d}^{#3} #1}{\mathrm{d} #2^{#3}}}
        \newcommand{\d}[2]{\frac{\mathrm{d} #1}{\mathrm{d} #2}}
        \newcommand{\dd}[2]{\frac{\mathrm{d}^2 #1}{\mathrm{d} {#2}^2}}
        \newcommand{\ddd}[2]{\frac{\mathrm{d}^3 #1}{\mathrm{d} {#2}^3}}
        \newcommand{\pdn}[3]{\frac{\partial^{#3} #1}{\partial {#2}^{#3}}}
        \newcommand{\pd}[2]{\frac{\partial #1}{\partial #2}}
        \newcommand{\pdd}[2]{\frac{\partial^2 #1}{\partial {#2}^2}}
        \newcommand{\pddd}[2]{\frac{\partial^3 #1}{\partial {#2}^3}}
        \newcommand{\p}{\partial} \newcommand{\D}[2]{\frac{\mathrm{D}
        #1}{\mathrm{D} #2}} \newcommand{\Re}{\mathrm{Re}}
        \newcommand{\Im}{\mathrm{Im}} \newcommand{\bra}[1]{\left\langle #1
        \right|} \newcommand{\ket}[1]{\left|#1 \right\rangle}
        \newcommand{\braket}[2]{\left\langle #1 \middle|#2 \right\rangle}
        \newcommand{\inner}[2]{\left\langle #1 ,#2 \right\rangle}
        \newcommand{\l}{\left} \newcommand{\m}{\middle} \newcommand{\r}{\right}
        \newcommand{\f}[2]{\frac{#1}{#2}} \newcommand{\eps}{\varepsilon}
        \newcommand{\ra}{\rightarrow} \newcommand{\F}{\mathcal{F}}
        \newcommand{\L}{\mathcal{L}} \newcommand{\t}{\quad}
        \newcommand{\intinf}{\int_{-\infty}^{+\infty}}
        \newcommand{\R}{\mathcal{R}} \newcommand{\C}{\mathcal{C}}
        \newcommand{\Z}{\mathcal{Z}} \newcommand{\bm}[1]{\boldsymbol{#1}} \]
      </p>

      <!-- Table of Contents -->
            <nav><ul>
<li><a href="#レジスタ">レジスタ</a></li>
<li><a href="#命令セット">命令セット</a><ul>
<li><a href="#レジスタ演算">レジスタ演算</a></li>
<li><a href="#即値演算">即値演算</a></li>
<li><a href="#即値ロード">即値ロード</a></li>
<li><a href="#メモリアクセス">メモリアクセス</a></li>
<li><a href="#条件分岐">条件分岐</a></li>
<li><a href="#ジャンプ">ジャンプ</a></li>
<li><a href="#割り込み">割り込み</a></li>
<li><a href="#サブルーチン">サブルーチン</a></li>
<li><a href="#割り込み処理">割り込み処理</a></li>
<li><a href="#割り込み-1">割り込み</a></li>
<li><a href="#実行時エラー">実行時エラー</a></li>
</ul></li>
<li><a href="#メモリ空間">メモリ空間</a><ul>
<li><a href="#レジスタ-1">レジスタ</a></li>
<li><a href="#io">IO</a></li>
<li><a href="#vram-dual-access-sram">VRAM (Dual access SRAM)</a></li>
<li><a href="#rom-eeprom">ROM (EEPROM)</a></li>
<li><a href="#ram-sram">RAM (SRAM)</a></li>
</ul></li>
<li><a href="#回路">回路</a><ul>
<li><a href="#id">ID</a></li>
<li><a href="#pfc">PFC</a></li>
</ul></li>
</ul></nav>
       <p>RISC-V をベースに、16bit 向けに小細工をしました。</p>
<h2 id="レジスタ">レジスタ</h2>
<table>
<thead>
<tr class="header">
<th></th>
<th></th>
<th>機能</th>
<th>保持</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>x0</td>
<td>zero</td>
<td>ゼロ固定</td>
<td>-</td>
</tr>
<tr class="even">
<td>x1</td>
<td>ra</td>
<td>戻りアドレス</td>
<td>✕</td>
</tr>
<tr class="odd">
<td>x2</td>
<td>sp</td>
<td>スタック・ポインタ</td>
<td>〇</td>
</tr>
<tr class="even">
<td>x3</td>
<td>gp</td>
<td>グローバル・ポインタ</td>
<td>〇</td>
</tr>
<tr class="odd">
<td>x4-7</td>
<td>s0-3</td>
<td>保存レジスタ</td>
<td>〇</td>
</tr>
<tr class="even">
<td>x8-11</td>
<td>t0-3</td>
<td>一時レジスタ</td>
<td>✕</td>
</tr>
<tr class="odd">
<td>x12-15</td>
<td>a0-3</td>
<td>引数・返値</td>
<td>✕</td>
</tr>
<tr class="even">
<td>-</td>
<td>pc</td>
<td>プログラムカウンタ</td>
<td>-</td>
</tr>
<tr class="odd">
<td>-</td>
<td>csr</td>
<td>コントロール＆ステータスレジスタ</td>
<td>-</td>
</tr>
</tbody>
</table>
<h2 id="命令セット">命令セット</h2>
<p><img src="img/isa.png" /></p>
<p><code>r[x0]</code> はレジスタ x0 の値を、<code>m[xx]</code> はメモリの xx 番地の値を意味します。</p>
<p><code>i(x)</code> は x bit の即値を、<code>is</code> は符号拡張する即値を意味します。</p>
<h4 id="符号拡張とは">符号拡張とは</h4>
<p>4bit の符号付き整数を 8bit にしたい場合、正の数は 0 を埋めればいいですが、負の数は 1 を埋める必要になります。符号付き整数の符号は、最上位 bit で表されるので、一般に、符号付き整数の bit 長を伸ばしたい場合、最上位ビットで埋める必要があります。これが符号拡張です。</p>
<table>
<tbody>
<tr class="odd">
<td>1</td>
<td>0000</td>
<td>0001</td>
</tr>
<tr class="even">
<td>1</td>
<td></td>
<td><strong>0</strong>001</td>
</tr>
<tr class="odd">
<td>0</td>
<td></td>
<td>0000</td>
</tr>
<tr class="even">
<td>-1</td>
<td></td>
<td><strong>1</strong>111</td>
</tr>
<tr class="odd">
<td>-1</td>
<td>1111</td>
<td>1111</td>
</tr>
</tbody>
</table>
<p>RISC-K では RISC-V に倣って、命令の即値の最上位 bit の位置を揃えることで、符号拡張のハードウェアを単純にします。</p>
<h3 id="レジスタ演算">レジスタ演算</h3>
<blockquote>
<p>add rd, rs1, rs2</p>
<p>r[rd] = r[rs1] + r[rs2]</p>
</blockquote>
<table>
<thead>
<tr class="header">
<th></th>
<th>演算</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>+</td>
<td>add</td>
</tr>
<tr class="even">
<td>-</td>
<td>sub</td>
</tr>
<tr class="odd">
<td>^</td>
<td>xor</td>
</tr>
<tr class="even">
<td>|</td>
<td>or</td>
</tr>
<tr class="odd">
<td>&amp;</td>
<td>and</td>
</tr>
<tr class="even">
<td>&lt;</td>
<td>less than</td>
</tr>
<tr class="odd">
<td>&lt;</td>
<td>less than unsigned</td>
</tr>
<tr class="even">
<td>&gt;&gt;</td>
<td>shift left logical</td>
</tr>
<tr class="odd">
<td>&gt;&gt;</td>
<td>shift left arithmetic</td>
</tr>
<tr class="even">
<td>&lt;&lt;</td>
<td>shift right logical</td>
</tr>
<tr class="odd">
<td>&lt;&lt;</td>
<td>shift right arithmetic</td>
</tr>
</tbody>
</table>
<h3 id="即値演算">即値演算</h3>
<blockquote>
<p>addi rd, rs1, is(8)</p>
<p>r[rd] = r[rs1] + is(8)</p>
</blockquote>
<p>16bit で演算したい場合は、即値ロードをした後に演算をする。</p>
<h3 id="即値ロード">即値ロード</h3>
<blockquote>
<p>li rd, i(16) (Load Immidiate)</p>
<p>r[rd] = i(16)</p>
</blockquote>
<h3 id="メモリアクセス">メモリアクセス</h3>
<blockquote>
<p>l rd, rs1, is(12)</p>
<p>r[rd] = m[r[rs1]+is(12)]</p>
</blockquote>
<blockquote>
<p>s rs1, rs2, is(12)</p>
<p>m[r[rs1]+is(12)] = r[rs2]</p>
</blockquote>
<p>rs1 を zero レジスタとすることで、絶対参照ができる。</p>
<p>12bit より広い範囲を参照したい場合は即値ロードを使う。</p>
<h3 id="条件分岐">条件分岐</h3>
<blockquote>
<p>jie rs1, rs2, is(12) (Jump If rs1 Equal rs2)</p>
<p>jil rs1, rs2, is(12) (Jump If rs1 is Less than rs2)</p>
<p>PC += is(12)</p>
</blockquote>
<p>ALU で減算 r[rs1] - r[rs2] を行い、その結果で分岐判定をします。</p>
<p>分岐先アドレスは、現在の PC に即値を足したアドレスです。</p>
<p>即値は符号拡張するので、マイナスのアドレスにも分岐できます。</p>
<p>分岐条件は、</p>
<ol type="1">
<li><p>一致（r[rs1] == r[rs2]）</p>
<p>演算結果の全 bit の nor を取る（全部 0 のときだけ 1）</p></li>
<li><p>未満（r[rs1] &lt; r[rs2]）</p>
<p>演算結果の符号 bit（負の場合は 1）</p></li>
</ol>
<h3 id="ジャンプ">ジャンプ</h3>
<blockquote>
<p>j rd, i(16) (Call)</p>
<p>r[rd] = PC + 1</p>
<p>PC = i(16)</p>
</blockquote>
<blockquote>
<p>jr rd, rs1, is(12)</p>
<p>r[rd] = PC + 1</p>
<p>PC = r[rs1] + is(12)</p>
</blockquote>
<p>戻りアドレスを rd に保存し、PC を即値にする。</p>
<h4 id="分岐とジャンプの違いについて">分岐とジャンプの違いについて</h4>
<p>分岐は関数内での if 文に、ジャンプは関数呼び出しに対応する。</p>
<p>if の分岐先は近いアドレスであるが、関数呼び出しは遠いアドレスであることも多い。</p>
<p>また、関数呼び出しは戻りアドレスを記憶しておく必要がある。</p>
<p>条件分岐はコンパイラで相対位置を決める。</p>
<p>関数呼び出しはリンカが絶対位置を決める。</p>
<h3 id="割り込み">割り込み</h3>
<blockquote>
<p>intr xxxxx</p>
</blockquote>
<p>割り込みフラグを設定する。</p>
<h3 id="サブルーチン">サブルーチン</h3>
<p><a href="https://inst.eecs.berkeley.edu/~cs61c/resources/RISCV_Calling_Convention.pdf">参考</a></p>
<table>
<thead>
<tr class="header">
<th>ASM</th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>subi sp sp 5</td>
<td>スタックポインタを減算し、スタックを確保</td>
</tr>
<tr class="even">
<td>store s0 0(sp)</td>
<td>レジスタをスタックに退避</td>
</tr>
<tr class="odd">
<td>store s1 1(sp)</td>
<td></td>
</tr>
<tr class="even">
<td>store s1 2(sp)</td>
<td></td>
</tr>
<tr class="odd">
<td>store s1 3(sp)</td>
<td></td>
</tr>
<tr class="even">
<td>store ra 4(sp)</td>
<td>リターンアドレスも退避</td>
</tr>
<tr class="odd">
<td>loadi a0 334</td>
<td>引数をレジスタにセット</td>
</tr>
<tr class="even">
<td></td>
<td>レジスタが足りなければスタックにセット</td>
</tr>
<tr class="odd">
<td>jal</td>
<td>サブルーチンにジャンプ</td>
</tr>
<tr class="even">
<td>:</td>
<td></td>
</tr>
<tr class="odd">
<td>:</td>
<td>サブルーチンの処理</td>
</tr>
<tr class="even">
<td>:</td>
<td></td>
</tr>
<tr class="odd">
<td>load ra 0(sp)</td>
<td>レジスタを復元</td>
</tr>
<tr class="even">
<td>load ra 1(sp)</td>
<td></td>
</tr>
<tr class="odd">
<td>load ra 2(sp)</td>
<td></td>
</tr>
<tr class="even">
<td>load ra 3(sp)</td>
<td></td>
</tr>
<tr class="odd">
<td>load ra 4(sp)</td>
<td>リターンアドレスを復元</td>
</tr>
<tr class="even">
<td>addi sp sp 5</td>
<td>スタックポインタを加算</td>
</tr>
<tr class="odd">
<td>jr ra</td>
<td>PC を戻す</td>
</tr>
</tbody>
</table>
<h3 id="割り込み処理">割り込み処理</h3>
<table>
<thead>
<tr class="header">
<th>ASM</th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>subi sp 16</td>
<td>全てのレジスタをスタックに退避</td>
</tr>
<tr class="even">
<td>store x1 0(sp)</td>
<td></td>
</tr>
<tr class="odd">
<td>:</td>
<td></td>
</tr>
<tr class="even">
<td>store x15 14(sp)</td>
<td></td>
</tr>
<tr class="odd">
<td>jal</td>
<td>ジャンプ</td>
</tr>
<tr class="even">
<td>:</td>
<td></td>
</tr>
<tr class="odd">
<td>:</td>
<td>割り込み処理を行う</td>
</tr>
<tr class="even">
<td>:</td>
<td></td>
</tr>
<tr class="odd">
<td>load x1 0{sp}</td>
<td>レジスタを復元</td>
</tr>
<tr class="even">
<td>:</td>
<td></td>
</tr>
<tr class="odd">
<td>load x15 14(sp)</td>
<td></td>
</tr>
<tr class="even">
<td>jr ra</td>
<td>PC を戻す</td>
</tr>
</tbody>
</table>
<h3 id="割り込み-1">割り込み</h3>
<h3 id="実行時エラー">実行時エラー</h3>
<p>割り込みとしてエラー処理を行う。</p>
<p>エラーコードを状態レジスタにセットし割り込み。</p>
<ul>
<li>スタックオーバーフロー</li>
<li>メモリの範囲外アクセス</li>
</ul>
<h2 id="メモリ空間">メモリ空間</h2>
<table>
<thead>
<tr class="header">
<th>Addr</th>
<th>Function</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0000 ~ 000F</td>
<td>レジスタ</td>
</tr>
<tr class="even">
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>IO</td>
</tr>
<tr class="even">
<td></td>
<td>VRAM</td>
</tr>
<tr class="odd">
<td></td>
<td>EEPROM</td>
</tr>
<tr class="even">
<td></td>
<td>RAM</td>
</tr>
</tbody>
</table>
<h3 id="レジスタ-1">レジスタ</h3>
<ul>
<li>実体としては、SRAM の一部分</li>
<li>4bit でアクセスする → ISA でビットを節約できる</li>
</ul>
<h3 id="io">IO</h3>
<p>IO は SRAM とは別に Dual Port SRAM または DFF の IC を使って実装する。</p>
<p>このアドレスへのメモリアドレスは、別のデバイスにスイッチする。</p>
<p>各 IO に必要なパラメタ数がわからないので、仮です。</p>
<h4 id="gpio">GPIO</h4>
<h4 id="adc">ADC</h4>
<h4 id="dac">DAC</h4>
<h4 id="pwm">PWM</h4>
<h4 id="uart">UART</h4>
<h4 id="spi">SPI</h4>
<h4 id="i2c">I2C</h4>
<h3 id="vram-dual-access-sram">VRAM (Dual access SRAM)</h3>
<p>表示の候補として、</p>
<ul>
<li>300 x 400 画素 : RGB 4 段階 (6bit)</li>
<li>300 x 400 画素 : 白黒 2 段階 (1bit)</li>
<li>テキスト表示（フォントを EEPROM に置いておく）</li>
</ul>
<h3 id="rom-eeprom">ROM (EEPROM)</h3>
<h3 id="ram-sram">RAM (SRAM)</h3>
<h2 id="回路">回路</h2>
<p><img src="img/arch.dio.svg" /></p>
<h3 id="id">ID</h3>
<p>命令デコーダ。機械語命令をもとに、マルチプレクサを切り替えて、データの経路を決める。</p>
<h4 id="動作">動作：</h4>
<p>4 クロックで 1 命令を実行する。</p>
<p>それぞれのステージで何をするか</p>
<ol start="0" type="1">
<li>PC のカウントアップ</li>
<li>メモリを読み出し、RS1 に記録</li>
<li>メモリを読み出し、RS2 に記録</li>
<li>メモリに書き込み</li>
</ol>
<table>
<thead>
<tr class="header">
<th></th>
<th>ALU</th>
<th>S2</th>
<th>0.ADR</th>
<th>1.ADR</th>
<th>2.ADR</th>
<th>DIN</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>add</td>
<td>Func</td>
<td>RS2</td>
<td>R RS1</td>
<td>R RS2</td>
<td>W RD</td>
<td>ALU</td>
</tr>
<tr class="even">
<td>addi</td>
<td>Func</td>
<td>IMM</td>
<td>R RS1</td>
<td>-</td>
<td>W RD</td>
<td>ALU</td>
</tr>
<tr class="odd">
<td>l</td>
<td>ADD</td>
<td>IMM</td>
<td>R RS1</td>
<td>R ALU</td>
<td>W RD</td>
<td>RS2</td>
</tr>
<tr class="even">
<td>s</td>
<td>ADD</td>
<td>IMM</td>
<td>R RS1</td>
<td>R RS2</td>
<td>W ALU</td>
<td>RS2</td>
</tr>
<tr class="odd">
<td>li</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>W RD</td>
<td>IMM</td>
</tr>
<tr class="even">
<td>be</td>
<td>SUB</td>
<td>RS2</td>
<td>R RS1</td>
<td>R RS2</td>
<td>-</td>
<td>-</td>
</tr>
<tr class="odd">
<td>bl</td>
<td>SUB</td>
<td>RS2</td>
<td>R RS1</td>
<td>R RS2</td>
<td>-</td>
<td>-</td>
</tr>
<tr class="even">
<td>j</td>
<td>ADD</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>W RD</td>
<td>PC</td>
</tr>
<tr class="odd">
<td>jr</td>
<td>ADD</td>
<td>IMM</td>
<td>R RS1</td>
<td>-</td>
<td>W RD</td>
<td>PC</td>
</tr>
</tbody>
</table>
<p><img src="img/decode.dio.svg" /></p>
<h4 id="タイミングチャート">タイミングチャート：</h4>
<ol start="0" type="1">
<li>PC のカウントアップ</li>
<li><p>S1 のロード</p>
<p>アドレスに RS1 をセットします。</p></li>
<li><p>S2 のロード</p></li>
</ol>
<p>ALU の 2 つの入力を S1,S2 レジスタにセットします。</p>
<ol start="3" type="1">
<li>実行</li>
</ol>
<h4 id="即値デコード">即値デコード：</h4>
<p><img src="img/imm_decode.dio.svg" /></p>
<h3 id="pfc">PFC</h3>
<p>プログラムフローコントローラ。</p>
<p>ジャンプ命令、分岐命令、割り込みによる、プログラムの流れの変化を処理する。</p>
<p><img src="img/pfc.dio.svg" /></p>
<h4 id="動作-1">動作：</h4>
<table>
<thead>
<tr class="header">
<th></th>
<th>次の PC</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>-</td>
<td>PC+1</td>
</tr>
<tr class="even">
<td>jie</td>
<td>ALU=0 ? PC+IMM : PC+1</td>
</tr>
<tr class="odd">
<td>jil</td>
<td>ALU&gt;0 ? PC+IMM : PC+1</td>
</tr>
<tr class="even">
<td>j</td>
<td>IMM</td>
</tr>
<tr class="odd">
<td>jr</td>
<td>ALU</td>
</tr>
</tbody>
</table>

      <button class="comment-button" onclick="tweet();">コメント</button>
    </article>
  </body>
</html>
