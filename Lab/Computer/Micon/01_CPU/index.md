---
title: 自作マイコン用CPU、RISC-K
---

## 概要

- メインメモリ空間とプログラムメモリ空間が分離された、ハーバードアーキテクチャ

## メモリ空間

| Addr | Function       |
| ---- | -------------- |
| 0000 | 汎用レジスタ   |
| 0010 | 演算レジスタ   |
| 0020 | 入出力レジスタ |
|      | VRAM           |
|      | EEPROM         |
|      | RAM            |

### 汎用レジスタ

| Addr |     |      | Func                 |
| ---- | --- | ---- | -------------------- |
| 0000 | x0  | zero | ゼロ固定             |
| 0001 | x1  | ra   | 戻りアドレス         |
| 0002 | x2  | sp   | スタック・ポインタ   |
| 0003 | x3  | gp   | グローバル・ポインタ |
| 0004 | x4  | tp   | スレッド・ポインタ   |
| 0005 | x5  | t0   | 一時レジスタ         |
| 0006 | x6  | t1   | 一時レジスタ         |
| 0007 | x7  | t2   | 一時レジスタ         |
| 0008 | x8  |      |                      |
| 0009 | x9  |      |                      |
| 000A | x10 |      |                      |
| 000B | x11 |      |                      |
| 000C | x12 |      |                      |
| 000D | x13 |      |                      |
| 000E | x14 |      |                      |
| 000F | x15 | imm  | 即値                 |

### IO

各 IO に必要なパラメタ数がわからないので、仮です。

| Addr | Func |
| ---- | ---- |
| 0020 | GPIO |
| 0028 | ADC  |
| 002C | DAC  |
| 0030 | PWM  |
| 0038 | I2C  |
| 00   | SPI  |
|      | UART |

### VRAM (Dual access SRAM)

表示の候補として、

- 300 x 400 画素 : RGB 4 段階 (6bit)
- 300 x 400 画素 : 白黒 2 段階 (1bit)
- テキスト表示（フォントを EEPROM に置いておく）

### ROM (EEPROM)

### RAM (SRAM)

## 命令セット

### 命令フォーマット

即値が必要な場合は次のアドレスに書かれている。

|     | 15-12 | 11-8   | 7-4    | 3-0   |                                 |
| --- | ----- | ------ | ------ | ----- | ------------------------------- |
|     | OPC   | Reg R1 | Reg R2 | Reg W | Reg W = ALU_OPC(Reg R1, Reg R2) |
| IMM | IMM   | IMM    | IMM    | IMM   |
| R-M | OPC   | OPC    | OPC    | OPC   |
| P   | OPC   | OPC    | OPC    | OPC   |

### 演算命令

|     |     |     |
| --- | --- | --- |
|     |     |     |

### 移動系命令

|         |                             | 引数                            |
| ------- | --------------------------- | ------------------------------- |
| mov     | レジスタ → レジスタ         | 1.レジスタ番号 2.レジスタ番号   |
| load    | メモリ → レジスタ           | 1.レジスタ番号 2.メモリアドレス |
| store   | レジスタ → メモリ           | 1.レジスタ番号 2.メモリアドレス |
| load_a  | メモリ[レジスタ] → レジスタ | 1.レジスタ番号 2.レジスタ番号   |
| store_a | レジスタ → メモリ[レジスタ] | 1.レジスタ番号 2.レジスタ番号   |

### 制御系命令

|          |              | 引数            | 説明                                         |
| -------- | ------------ | --------------- | -------------------------------------------- |
| jmpif    | 条件分岐     | 1.条件 2.分岐先 |                                              |
| call     | 関数呼び出し | 1.アドレス      |                                              |
| ret      | 関数抜け出し | -               |                                              |
| intr     | 割込呼び出し | 1.例外コード    | 全てのレジスタを退避し、ハンドラへ制御を渡す |
| ret_intr | 割込抜け出し | -               | 退避したレジスタを戻し、元の処理に戻る       |
| ac_intr  | 割込受付     |                 |                                              |
| rj_intr  | 割込拒否     |                 |                                              |

### サブルーチン

https://inst.eecs.berkeley.edu/~cs61c/resources/RISCV_Calling_Convention.pdf

1. 退避するレジスタ数だけ、スタックポインタを減算
2. レジスタをスタックに退避
3. リターンアドレスをスタックに退避
4. 引数をレジスタにセット
5. レジスタが足りなければスタックにセット
6. サブルーチンにジャンプ

7. レジスタを復元
8. リターンアドレスを復元
9. スタックポインタを加算
10. リターンアドレスにジャンプ

### 割り込み

## VFC/PFC アーキテクチャ

記憶されている値の移動を行う Value Flow Controller (VFC) と、

プログラムの制御を行う Program Flow Controller (PFC) からなるアーキテクチャ。

![](./img/arch.dio.svg)
