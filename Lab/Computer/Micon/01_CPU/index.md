---
title: 自作マイコン用CPU、RISC-K
---

## 概要

- メインメモリ空間とプログラムメモリ空間が分離された、ハーバードアーキテクチャ

## メモリ空間

| Addr | Function       |
| ---- | -------------- |
| 0000 | 汎用レジスタ   |
| 0010 | 演算レジスタ   |
| 0020 | 入出力レジスタ |
|      | VRAM           |
|      | EEPROM         |
|      | RAM            |

### 汎用レジスタ

| Addr |     |               | Func             |
| ---- | --- | ------------- | ---------------- |
| 0000 | x0  | zero          | ゼロ固定         |
| 0001 | x1  | retern_addr   | 戻りアドレス     |
| 0002 | x2  | stack_pointer | スタックポインタ |
| 0003 | x3  |               |                  |
| 0004 | x4  |               |                  |
| 0005 | x5  |               |                  |
| 0006 | x6  |               |                  |
| 0007 | x7  |               |                  |
| 0008 |     |               |                  |
| 0009 |     |               |                  |
| 000A |     |               |                  |
| 000B |     |               |                  |
| 000C |     |               |                  |
| 000D |     |               |                  |
| 000E |     |               |                  |
| 000F |     |               |                  |

### 演算レジスタ

このアーキテクチャでは、演算命令を mov のエイリアスとして実装します。

レジスタアクセスと同じ手続きで、演算結果を得るようなハードウェアになっているからです。

| Addr |          | Func                       |
| ---- | -------- | -------------------------- |
| 0010 | alu_conf | ALU の入出力レジスタを指定 |
| 0010 | sl       | < 左シフト                 |
| 0011 | sr       | > 右シフト                 |
| 0012 | add      | +                          |
| 0013 | sub      | -                          |
| 0014 | xor      | ^                          |
| 0015 | or       | \|                         |
| 0016 | and      | &                          |
| 0017 | not      | ~                          |
| 0018 |          |                            |
| 0019 |          |                            |
| 001A |          |                            |
| 001B |          |                            |
| 001C |          |                            |
| 001D |          |                            |
| 001E |          |                            |
| 001F |          |                            |

### 入出力レジスタ

各 IO に必要なレジスタ数がわからないので、仮です。

| Addr | Func |
| ---- | ---- |
| 0020 | GPIO |
| 0028 | ADC  |
| 002C | DAC  |
| 0030 | PWM  |
| 0038 | I2C  |
| 00   | SPI  |
|      | UART |

### VRAM (Dual access SRAM)

表示の候補として、

- 300 x 400 画素 : RGB 4 段階 (6bit)
- 300 x 400 画素 : 白黒 2 段階 (1bit)
- テキスト表示（フォントを EEPROM に置いておく）

### ROM (EEPROM)

### RAM (SRAM)

## 命令セット

### 命令フォーマット

|     | 15  | 14  | 13  | 12  | 11  | 10  | 9   | 8   | 7   | 6   | 5   | 4   | 3   | 2   | 1   | 0   |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| R-R | OPC | OPC | OPC | OPC | R1  | R1  | R1  | R1  | R1  | R1  | R2  | R2  | R2  | R2  | R2  | R2  |
| R-M | OPC | OPC | OPC | OPC |
| P   | OPC | OPC | OPC | OPC |

### 移動系命令

|         |                             | 引数                            |
| ------- | --------------------------- | ------------------------------- |
| mov     | レジスタ → レジスタ         | 1.レジスタ番号 2.レジスタ番号   |
| load    | メモリ → レジスタ           | 1.レジスタ番号 2.メモリアドレス |
| store   | レジスタ → メモリ           | 1.レジスタ番号 2.メモリアドレス |
| load_a  | メモリ[レジスタ] → レジスタ | 1.レジスタ番号 2.レジスタ番号   |
| store_a | レジスタ → メモリ[レジスタ] | 1.レジスタ番号 2.レジスタ番号   |

### 制御系命令

|          |              | 引数            | 説明                                         |
| -------- | ------------ | --------------- | -------------------------------------------- |
| jmpif    | 条件分岐     | 1.条件 2.分岐先 |                                              |
| call     | 関数呼び出し | 1.アドレス      |                                              |
| ret      | 関数抜け出し | -               |                                              |
| intr     | 割込呼び出し | 1.例外コード    | 全てのレジスタを退避し、ハンドラへ制御を渡す |
| ret_intr | 割込抜け出し | -               | 退避したレジスタを戻し、元の処理に戻る       |
| ac_intr  | 割込受付     |                 |                                              |
| rj_intr  | 割込拒否     |                 |                                              |

## VFC/PFC アーキテクチャ

記憶されている値の移動を行う Value Flow Controller (VFC) と、

プログラムの制御を行う Program Flow Controller (PFC) からなるアーキテクチャ。

![](./img/arch.dio.svg)

### サブルーチン

### 割り込み
