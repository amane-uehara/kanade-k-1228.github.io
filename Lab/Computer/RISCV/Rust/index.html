<!-- (ฅ^･ω･^ฅ) ﾆｬｰ -->

<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja" prefix="og: http://ogp.me/ns#">
  <head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-114187773-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "UA-114187773-1");
    </script>
    <!-- End Google Analytics -->
    <!-- Load Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap" rel="stylesheet" />
    <!-- End Google Font -->

    <meta charset="utf-8" />
    <meta name="generator" content="pandoc" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <meta name="author" content="@kanade_k_1228" />
    <link rel="shortcut icon" href="https://avatars.githubusercontent.com/u/54773334" />
          <title>自作 RISC-V マイコンを Rust で動かす | Kanade's Website</title>

    <!-- OGP -->
        <!-- END OGP -->

    <!-- Twitter Card -->
        <!-- END Twitter Card -->

    <link rel="stylesheet" href="https://kanade-k-1228.github.io/.common/light.css" id="style" />
        <script
      type="text/javascript"
      id="MathJax-script"
      async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
    ></script>
    <style>
      mjx-container[jax="CHTML"][display="true"] {
        display: block;
        text-align: center;
        margin: 0;
      }
    </style>

    <!-- SyntaxHighlight -->
    <link rel="stylesheet" href="https://kanade-k-1228.github.io/.common/highlight.css" />
    <script src="https://kanade-k-1228.github.io/.common/highlight.min.js"></script>
    <script>
      hljs.initHighlightingOnLoad();
    </script>

    <script>
      function tweet() {
        window.open(
          "https://twitter.com/intent/tweet?via=kanade_k_1228&related=kanade_k_1228&url=" +
            location.href +
            "&text=" +
            "自作 RISC-V マイコンを Rust で動かす",
          "_blank"
        );
      }
    </script>
    <script src="https://kanade-k-1228.github.io/.common/changeStyle.js"></script>
    <script src="https://kanade-k-1228.github.io/.common/command.js"></script>
  </head>

  <body>
    <article>
      <header>
        <ul>
          <li><a href="/">ﾎｰﾑ</a></li>
          <li><a href="/Portfolio/">ﾎﾟﾄﾌｫﾘｵ</a></li>
          <li><a href="/Lab/">研究室</a></li>
          <li><a href="/Blog/">雑記</a></li>
        </ul>
        <div id="header-links">
          <a href="https://twitter.com/kanade_k_1228" target="_blank">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="50"
              height="50"
              viewBox="126.444 2.281 589 589"
              style="margin: 0; padding: 0"
            >
              <circle cx="420.944" cy="296.781" r="294.5" fill="#2daae1" />
              <path
                d="M609.773 179.634c-13.891 6.164-28.811 10.331-44.498 12.204 16.01-9.587 28.275-24.779 34.066-42.86a154.78 154.78 0 0 1-49.209 18.801c-14.125-15.056-34.267-24.456-56.551-24.456-42.773 0-77.462 34.675-77.462 77.473 0 6.064.683 11.98 1.996 17.66-64.389-3.236-121.474-34.079-159.684-80.945-6.672 11.446-10.491 24.754-10.491 38.953 0 26.875 13.679 50.587 34.464 64.477a77.122 77.122 0 0 1-35.097-9.686v.979c0 37.54 26.701 68.842 62.145 75.961-6.511 1.784-13.344 2.716-20.413 2.716-4.998 0-9.847-.473-14.584-1.364 9.859 30.769 38.471 53.166 72.363 53.799-26.515 20.785-59.925 33.175-96.212 33.175-6.25 0-12.427-.373-18.491-1.104 34.291 21.988 75.006 34.824 118.759 34.824 142.496 0 220.428-118.052 220.428-220.428 0-3.361-.074-6.697-.236-10.021a157.855 157.855 0 0 0 38.707-40.158z"
                fill="#fff"
              />
            </svg>
          </a>
          <a href="https://github.com/kanade-k-1228" target="_blank">
            <svg width="50px" height="50px" viewBox="0 0 1024 1024" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path
                fill-rule="evenodd"
                clip-rule="evenodd"
                d="M8 0C3.58 0 0 3.58 0 8C0 11.54 2.29 14.53 5.47 15.59C5.87 15.66 6.02 15.42 6.02 15.21C6.02 15.02 6.01 14.39 6.01 13.72C4 14.09 3.48 13.23 3.32 12.78C3.23 12.55 2.84 11.84 2.5 11.65C2.22 11.5 1.82 11.13 2.49 11.12C3.12 11.11 3.57 11.7 3.72 11.94C4.44 13.15 5.59 12.81 6.05 12.6C6.12 12.08 6.33 11.73 6.56 11.53C4.78 11.33 2.92 10.64 2.92 7.58C2.92 6.71 3.23 5.99 3.74 5.43C3.66 5.23 3.38 4.41 3.82 3.31C3.82 3.31 4.49 3.1 6.02 4.13C6.66 3.95 7.34 3.86 8.02 3.86C8.7 3.86 9.38 3.95 10.02 4.13C11.55 3.09 12.22 3.31 12.22 3.31C12.66 4.41 12.38 5.23 12.3 5.43C12.81 5.99 13.12 6.7 13.12 7.58C13.12 10.65 11.25 11.33 9.47 11.53C9.76 11.78 10.01 12.26 10.01 13.01C10.01 14.08 10 14.94 10 15.21C10 15.42 10.15 15.67 10.55 15.59C13.71 14.53 16 11.53 16 8C16 3.58 12.42 0 8 0Z"
                transform="scale(64)"
                fill="#1B1F23"
              />
            </svg>
          </a>
          <a href="https://t.co/E5xtfEQs4A" target="_blank">
            <img
              src="https://kanade-k-1228.github.io/.common/niconico.png"
              width="50px"
              height="50px"
              style="border-radius: 50%"
          /></a>
          <a href="https://www.youtube.com/channel/UCoeuc9-XQ5EpeYSCn4ESpQw" target="_blank">
            <svg width="50px" height="50px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 333333 333333">
              <path
                d="M166667 0c92048 0 166667 74619 166667 166667s-74619 166667-166667 166667S0 258715 0 166667 74619 0 166667 0zm84195 132297s-1678-11849-6843-17052c-6545-6843-13873-6887-17223-7283-24036-1751-60138-1751-60138-1751h-63s-36085 0-60135 1751c-3363 409-10681 437-17223 7283-5168 5203-6811 17052-6811 17052s-1711 13904-1711 27838v13029c0 13905 1709 27837 1709 27837s1678 11849 6811 17061c6542 6843 15139 6621 18977 7350 13761 1314 58457 1710 58457 1710s36133-64 60169-1783c3363-397 10678-438 17223-7284 5168-5202 6843-17065 6843-17065s1711-13904 1711-27837v-13028c-35-13905-1745-27837-1745-27837l-9 9-1-1zm-102010 56674v-48312l46437 24237-46437 24075z"
                fill="red"
              />
            </svg>
          </a>
        </div>
        <!-- End Top Nav -->
        <!-- Title -->
                <h1 style="margin: 0">自作 RISC-V マイコンを Rust で動かす</h1>
                <!-- Date -->
                <!-- Description -->
              </header>

      <!-- TeX Macros -->
      <!-- prettier-ignore -->
      <p style="display: none">
      \[ \newcommand{dn}[3]{\frac{\mathrm{d}^{#3} #1}{\mathrm{d} #2^{#3}}}
      \newcommand{\d}[2]{\frac{\mathrm{d} #1}{\mathrm{d} #2}}
      \newcommand{\dd}[2]{\frac{\mathrm{d}^2 #1}{\mathrm{d} {#2}^2}}
      \newcommand{\ddd}[2]{\frac{\mathrm{d}^3 #1}{\mathrm{d} {#2}^3}}
      \newcommand{\pdn}[3]{\frac{\partial^{#3} #1}{\partial {#2}^{#3}}}
      \newcommand{\pd}[2]{\frac{\partial #1}{\partial #2}}
      \newcommand{\pdd}[2]{\frac{\partial^2 #1}{\partial {#2}^2}}
      \newcommand{\pddd}[2]{\frac{\partial^3 #1}{\partial {#2}^3}}
      \newcommand{\p}{\partial}
      \newcommand{\D}[2]{\frac{\mathrm{D} #1}{\mathrm{D} #2}}
      \newcommand{\Re}{\mathrm{Re}}
      \newcommand{\Im}{\mathrm{Im}}
      \newcommand{\bra}[1]{\left\langle #1 \right|}
      \newcommand{\ket}[1]{\left|#1 \right\rangle}
      \newcommand{\braket}[2]{\left\langle #1 \middle|#2 \right\rangle}
      \newcommand{\inner}[2]{\left\langle #1 ,#2 \right\rangle}
      \newcommand{\l}{\left} \newcommand{\m}{\middle} \newcommand{\r}{\right}
      \newcommand{\f}[2]{\frac{#1}{#2}} \newcommand{\eps}{\varepsilon}
      \newcommand{\ra}{\rightarrow} \newcommand{\F}{\mathcal{F}}
      \newcommand{\L}{\mathcal{L}} \newcommand{\t}{\quad}
      \newcommand{\intinf}{\int_{-\infty}^{+\infty}}
      \newcommand{\R}{\mathcal{R}} \newcommand{\C}{\mathcal{C}}
      \newcommand{\Z}{\mathcal{Z}} \newcommand{\bm}[1]{\boldsymbol{#1}} \]
    </p>

      <!-- Table of Contents -->
            <nav><ul>
<li><a href="#環境構築">環境構築</a>
<ul>
<li><a href="#ツールチェーン">ツールチェーン</a></li>
</ul></li>
<li><a href="#最初のプログラム">最初のプログラム</a>
<ul>
<li><a href="#cargo">Cargo</a></li>
<li><a href="#l-チカ-仮">L チカ (仮)</a></li>
</ul></li>
<li><a href="#エントリポイントまで">エントリポイントまで</a>
<ul>
<li><a href="#リンカスクリプト">リンカスクリプト</a></li>
</ul></li>
<li><a href="#abi">ABI</a></li>
<li><a href="#リンカ">リンカ</a></li>
<li><a href="#アセンブラ">アセンブラ</a>
<ul>
<li><a href="#外部ファイル">外部ファイル</a></li>
<li><a href="#インラインアセンブラ">インラインアセンブラ</a></li>
<li><a href="#拡張命令">拡張命令</a></li>
</ul></li>
<li><a href="#スタートアップルーチン">スタートアップルーチン</a></li>
<li><a href="#割り込みハンドラ">割り込みハンドラ</a></li>
<li><a href="#ペリフェラル">ペリフェラル</a></li>
<li><a href="#l-チカ">L チカ</a>
<ul>
<li><a href="#コンパイルスクリプト">コンパイルスクリプト</a></li>
<li><a href="#シミュレータ">シミュレータ</a></li>
</ul></li>
<li><a href="#アセンブリの比較">アセンブリの比較</a></li>
</ul></nav>
       <p>いままで C++ をメインの言語として使ってきたのですが、最近コンパイラを作るのに Rust を使ってみたところかなり良かったので、今後作るものは Rust で書いきたいと思っています。ということで今回は FPGA に実装した自作 RISC-V マイコンを Rust で動かす方法を調べて実装してみます。</p>
<p>ソースコードは <span class="citation" data-cites="tnakabayashi">[@tnakabayashi]</span>(https://twitter.com/tnakabayashi) さんの <a href="https://github.com/tomoyuki-nakabayashi/riscv-rust-hello">riscv-rust-hello</a> を参考にしています。</p>
<p>また以下のドキュメントを参照しました。</p>
<p><a href="https://speakerdeck.com/tomoyuki/baremetal-rust-for-risc-v">Baremetal Rust for RISC-V</a></p>
<p><a href="https://tomoyuki-nakabayashi.github.io/embedded-rust-techniques/">Embedded Rust Techniques</a></p>
<p><a href="https://tomoyuki-nakabayashi.github.io/embedonomicon/">The Embedonomicon</a></p>
<p><a href="https://tomoyuki-nakabayashi.github.io/book/">The Embedded Rust Book</a></p>
<p><a href="https://doc.rust-jp.rs/rust-nomicon-ja/">Rust 裏本 高度で危険な Rust Programming のための闇の技法</a></p>
<p>環境は以下の通り。</p>
<pre><code>$ cat /etc/issue
Ubuntu 20.04.6 LTS \n \l
$ rustc -V
rustc 1.75.0 (82e1608df 2023-12-21)
$ cargo -V
cargo 1.75.0 (1d8b05cdd 2023-11-20)</code></pre>
<h2 id="環境構築">環境構築</h2>
<p>以下のコマンドで使いたいマシンが対応してるか調べることができます。</p>
<pre><code>$ rustc --print target-list
&gt; riscv32imc-unknown-none-elf</code></pre>
<p>これを target triplet と言い、コンパイラがどの計算機環境での実行バイナリを吐けばいいのかを、以下の項目で指定します。</p>
<ul>
<li>arch: riscv32</li>
<li>sub: imc</li>
<li>vendor: unknown</li>
<li>sys: none</li>
<li>abi: elf</li>
</ul>
<p>以下のコマンドでクロスコンパイラをインストールします。</p>
<pre><code>$ rustup target add riscv32imc-unknown-none-elf</code></pre>
<h3 id="ツールチェーン">ツールチェーン</h3>
<p>objdump や nm などのツールをインストールします。</p>
<pre><code>$ cargo install cargo-binutils
$ rustup component add llvm-tools-preview</code></pre>
<h2 id="最初のプログラム">最初のプログラム</h2>
<p><code>main.rs</code> を書きます。最小限のプログラムです。main すら存在しません。</p>
<pre><code>#![no_main]
#![no_std]

use core::panic::PanicInfo;

#[panic_handler]
fn panic(_panic: &amp;PanicInfo&lt;&#39;_&gt;) -&gt; ! {
    loop {}
}</code></pre>
<p>ターゲットを指定してコンパイルします。</p>
<pre><code>$ rustc --target riscv32imc-unknown-none-elf main.rs</code></pre>
<p>言語仕様上パニックハンドラだけは定義する必要があるようです。パニックハンドラを消すと、このようなエラーが出ます。</p>
<pre><code>error: `#[panic_handler]` function required, but not found</code></pre>
<p>吐かれたバイナリ中身を見てみます。</p>
<pre><code>$ rust-objdump ./main -x

./main: file format elf32-littleriscv
architecture: riscv32
start address: 0x00000000

Program Header:
    PHDR off    0x00000034 vaddr 0x00010034 paddr 0x00010034 align 2**2
         filesz 0x00000080 memsz 0x00000080 flags r--
    LOAD off    0x00000000 vaddr 0x00010000 paddr 0x00010000 align 2**12
         filesz 0x000000b4 memsz 0x000000b4 flags r--
   STACK off    0x00000000 vaddr 0x00000000 paddr 0x00000000 align 2**64
         filesz 0x00000000 memsz 0x00000000 flags rw-
 UNKNOWN off    0x000000f4 vaddr 0x00000000 paddr 0x00000000 align 2**0
         filesz 0x00000026 memsz 0x00000026 flags r--

Dynamic Section:

Sections:
Idx Name              Size     VMA      Type
  0                   00000000 00000000
  1 .comment          00000040 00000000
  2 .riscv.attributes 00000026 00000000
  3 .symtab           00000020 00000000
  4 .shstrtab         00000036 00000000
  5 .strtab           0000001d 00000000

SYMBOL TABLE:
00000000 l    df *ABS*  00000000 main.7c41ea6d61ccd5c8-cgu.0</code></pre>
<h3 id="cargo">Cargo</h3>
<p>Cargo を使えるようにします。 新しくディレクトリを作ります。</p>
<pre><code>$ mkdir rvrs
$ cd rvrs
$ cargo init</code></pre>
<p>設定ファイルを書きます。</p>
<pre><code># .cargo/config
[build]
target = &quot;riscv32imc-unknown-none-elf&quot;</code></pre>
<p><code>src/main.rs</code> を上記のコードで書き換えます。</p>
<p>以下のコマンドでコンパイルできます。</p>
<pre><code>$ cargo build</code></pre>
<p>以下のコマンドで逆アセンブルできます。</p>
<pre><code>$ cargo objdump --bin rvrs -- -x
(省略)</code></pre>
<p>謎のシンボルが増えていますが、<code>cargo build</code> がデフォルトでデバッグビルドをするためのようです。</p>
<p><code>--release</code> オプションを付けると、リリースビルドをして、逆アセンブルできます。</p>
<pre><code>$ cargo build --release
$ cargo objdump --bin rvrs --release -- -x</code></pre>
<h3 id="l-チカ-仮">L チカ (仮)</h3>
<p><code>0x0300_0000</code>番地に LED に繋がったレジスタがあるとしましょう。 L チカのコードは以下のようになります。</p>
<pre><code>#![no_main]
#![no_std]

#[no_mangle]
pub extern &quot;C&quot; fn __start_rust() -&gt; ! {
    let led = 0x0300_0000 as *mut u8;
    loop {
        unsafe {
            *led = 0;
            *led = 1;
        }
    }
}

use core::panic::PanicInfo;
#[panic_handler]
#[no_mangle]
pub fn panic(_info: &amp;PanicInfo) -&gt; ! {
    loop {}
}</code></pre>
<p><code>__start_rust</code> は Rust のエントリポイントです。 <code>led</code> というポインタを作って、それの指すアドレスに対して 0 と 1 を交互に書き込んで L チカしています。</p>
<p>これをビルドして中身を見てみます。</p>
<pre><code>$ cargo build
$ cargo objdump --bin rvrs -- -d

rvrs:   file format elf32-littleriscv

Disassembly of section .text.__start_rust:

80000000 &lt;_bss_start&gt;:
80000000: 41 11         addi    sp, sp, -16
80000002: 37 05 00 03   lui     a0, 12288
80000006: 2a c6         sw      a0, 12(sp)
80000008: 09 a0         j       0x8000000a &lt;_bss_start+0xa&gt;
8000000a: b7 05 00 03   lui     a1, 12288
8000000e: 01 45         li      a0, 0
80000010: 23 80 a5 00   sb      a0, 0(a1)
80000014: 05 45         li      a0, 1
80000016: 23 80 a5 00   sb      a0, 0(a1)
8000001a: c5 bf         j       0x8000000a &lt;_bss_start+0xa&gt;</code></pre>
<p><code>12288 = 0x3000</code> です。</p>
<h2 id="エントリポイントまで">エントリポイントまで</h2>
<p>実際に動作するバイナリを作っていきましょう！</p>
<h3 id="リンカスクリプト">リンカスクリプト</h3>
<p><code>.</code> は変数です！</p>
<p>マイコンが起動すると、まず ROM の 0 番地にある命令が実行されます。 これをリセットベクタと言ったりするのですが、</p>
<h2 id="abi">ABI</h2>
<p>Rust には安定した ABI がない <a href="https://github.com/rust-lang/rfcs/issues/600">Define a Rust ABI #600</a> そうです。</p>
<p>C 的人間がこのような関数を見たら、引数は順番にスタックに push されると考えがちですが、Rust ではそこに取り決めはないようです。最適化の中でフィールドの順番が入れ替わっているかもしれません。</p>
<pre><code>fn hoge(a: u8, b: u32, c: u8) -&gt; u32 {
    a + b + c
}</code></pre>
<p>TODO バイナリを見る</p>
<p>なので <code>extern "C"</code> で C の ABI を拝借します。</p>
<pre><code>extern &quot;C&quot; {
}</code></pre>
<p>また構造体も同じように、上から順番にメモリに配置されるわけではなく、入れ替えられる可能性があります。 <code>repr(C)</code> で C と同様に上から順番に配置できます。</p>
<pre><code>#[repr(C)]
struct Hoge{
    a: u8,
    b: u32,
    c: u8
}</code></pre>
<h2 id="リンカ">リンカ</h2>
<p>リンカは GCC の ld を使用できるため、今まで通りのリンカスクリプトを使用できます。</p>
<pre class="lds:"><code>MEMORY
{
    RAM   (rw) : ORIGIN = 0x00000000, LENGTH = 0x00002000 /* 8 KiB */
    FLASH (rx) : ORIGIN = 0x00050000, LENGTH = 0x00100000 /* entire flash, 1 MiB */
}

SECTIONS {
    /* 略 */
    .bss :
    {
        . = ALIGN(4);
        _sbss = .;
        *(.bss .bss.* .sbss .sbss.*)
        *(COMMON)
        . = ALIGN(4);
        _ebss = .;
    } &gt;RAM
    /* 略 */
}</code></pre>
<p>リンカスクリプト中で定義したシンボルを Rust 中で使用するには <code>static</code> 変数として宣言します。</p>
<pre class="rs:"><code>extern &quot;C&quot; {
    static mut _sbss: u32;
    static mut _ebss: u32;
}</code></pre>
<p>たとえば BSS 領域を 0 で初期化するには <code>ptr::write_bytes</code> (C の<code>memset</code>) を使用し以下のようにします。</p>
<pre class="rs:"><code>let count = &amp;_ebss as *const u8 as usize - &amp;_sbss as *const u8 as usize;
ptr::write_bytes(&amp;mut _sbss as *mut u8, 0, count);</code></pre>
<p>Attribute としてシンボル名とセッションを指定できます。</p>
<pre class="rs:"><code>#[export_name = &quot;foo&quot;]</code></pre>
<h2 id="アセンブラ">アセンブラ</h2>
<h3 id="外部ファイル">外部ファイル</h3>
<p>外部のアセンブラファイル <code>.s</code> を別途アセンブルし、rust とリンクします。 ここは通常の C と同じ方法でできます。</p>
<p>Rust は Makefile みたいなビルドスクリプトを Rust で記述できます。いいね。</p>
<p>TODO ビルドスクリプトを書く</p>
<h3 id="インラインアセンブラ">インラインアセンブラ</h3>
<p>インラインアセンブラは以下のように書きます。</p>
<pre class="rs:"><code>asm!(
    &quot;mov {tmp}, {x}&quot;,
    x = inout(reg) x,
    tmp = out(reg) _,
);</code></pre>
<p>詳細は<a href="https://doc.rust-lang.org/reference/inline-assembly.html">Rust リファレンス</a>を参照してください。</p>
<h3 id="拡張命令">拡張命令</h3>
<p>独自の拡張命令をラップしたアセンブラマクロ</p>
<pre><code>#define my_opr(rs1,rs2,rd) .word(/* 略 */)</code></pre>
<p>を使用するには <code>global_asm!</code> を使用します。</p>
<p>TODO 試す</p>
<h2 id="スタートアップルーチン">スタートアップルーチン</h2>
<p>ベアメタルのプログラムのエントリポイントは、割り込みベクタの先頭にあるリセットベクタになります。ここから、環境を整えて <code>main</code> 関数へと引き渡すまでの部分を、スタートアップルーチンと言います。</p>
<p>上で説明した <code>extern "C"</code> と <code>#[no_mangle]</code> を使用しシンボル名を同じにすることで、 C で開発していたものと同じアセンブラを使用できます。</p>
<h2 id="割り込みハンドラ">割り込みハンドラ</h2>
<h2 id="ペリフェラル">ペリフェラル</h2>
<p>ここ <a href="https://tomoyuki-nakabayashi.github.io/book/peripherals/index.html">The Embedded Rust Book | ペリフェラル</a> にだいたいのことが書いてあります。</p>
<p>有名なハードウェアに対しては、それをラップするクレートを実装してくれています。 が、自作マイコンの場合、それらを自分で書く必要があります。</p>
<p>今回は CPU に PicoRV32 というそこそこ有名なものを使用しているので、CPU のクレートは見つかりました。</p>
<p><a href="https://github.com/ilya-epifanov/picorv32-rt">picorv32-rt</a></p>
<p>CPU 以外のペリフェラルの部分は独自なので、自分で実装する必要があります。</p>
<p>まず、機能ごとにレジスタをまとめた構造体を定義します。</p>
<pre><code>#[repr(C)]
struct GPIO {
    pub iosel: u32,
    pub in: u32,
    pub out: u32,
}</code></pre>
<p>メモリのアドレスを指定して書き換えるには、</p>
<h2 id="l-チカ">L チカ</h2>
<p>以上で自作マイコンのプログラミング言語を C++ から Rust に移行するための道具は揃ったと思うので、実際にやっていきます。</p>
<h3 id="コンパイルスクリプト">コンパイルスクリプト</h3>
<h3 id="シミュレータ">シミュレータ</h3>
<p>iverilog でマイコンを動かして main 関数に到達していることを確認します。</p>
<h2 id="アセンブリの比較">アセンブリの比較</h2>
<p>最後に、C++ と Rust の吐いたアセンブリを比べてみます。 以下のコマンドでアセンブリを出力できます。</p>
<pre><code>$ rustc --emit asm main.rs</code></pre>

      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="50"
        height="50"
        viewBox="126.444 2.281 589 589"
        style="margin: auto; padding: 0; display: block"
        onclick="tweet();"
      >
        <circle cx="420.944" cy="296.781" r="294.5" fill="#2daae1" />
        <path
          d="M609.773 179.634c-13.891 6.164-28.811 10.331-44.498 12.204 16.01-9.587 28.275-24.779 34.066-42.86a154.78 154.78 0 0 1-49.209 18.801c-14.125-15.056-34.267-24.456-56.551-24.456-42.773 0-77.462 34.675-77.462 77.473 0 6.064.683 11.98 1.996 17.66-64.389-3.236-121.474-34.079-159.684-80.945-6.672 11.446-10.491 24.754-10.491 38.953 0 26.875 13.679 50.587 34.464 64.477a77.122 77.122 0 0 1-35.097-9.686v.979c0 37.54 26.701 68.842 62.145 75.961-6.511 1.784-13.344 2.716-20.413 2.716-4.998 0-9.847-.473-14.584-1.364 9.859 30.769 38.471 53.166 72.363 53.799-26.515 20.785-59.925 33.175-96.212 33.175-6.25 0-12.427-.373-18.491-1.104 34.291 21.988 75.006 34.824 118.759 34.824 142.496 0 220.428-118.052 220.428-220.428 0-3.361-.074-6.697-.236-10.021a157.855 157.855 0 0 0 38.707-40.158z"
          fill="#fff"
        />
      </svg>
    </article>
  </body>
</html>
