<!-- (ฅ^･ω･^ฅ) ﾆｬｰ -->

<!DOCTYPE html>
<html
  xmlns="http://www.w3.org/1999/xhtml"
  lang="ja"
  xml:lang="ja"
  prefix="og: http://ogp.me/ns#"
>
  <head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=UA-114187773-1"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "UA-114187773-1");
    </script>
    <!-- End Google Analytics -->
    <!-- Load Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap"
      rel="stylesheet"
    />
    <!-- End Google Font -->

    <meta charset="utf-8" />
    <meta name="generator" content="pandoc" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=yes"
    />
    <meta name="author" content="@kanade_k_1228" />
    <link
      rel="shortcut icon"
      href="https://avatars.githubusercontent.com/u/54773334"
    />
          <title>カルマンフィルタ | Kanade's Website</title>

    <!-- OGP -->
        <!-- END OGP -->

    <!-- Twitter Card -->
        <!-- END Twitter Card -->

    <link
      rel="stylesheet"
      href="https://kanade-k-1228.github.io/.common/light.css"
      id="style"
    />
        <script
      type="text/javascript"
      id="MathJax-script"
      async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
    ></script>
    <style>
      mjx-container[jax="CHTML"][display="true"] {
        display: block;
        text-align: center;
        margin: 0;
      }
    </style>
    <!-- SyntaxHighlight -->
    <link
      rel="stylesheet"
      href="https://kanade-k-1228.github.io/.common/highlight.css"
    />
    <script src="https://kanade-k-1228.github.io/.common/highlight.min.js"></script>
    <script>
      hljs.initHighlightingOnLoad();
    </script>

    <script>
      function tweet() {
        window.open(
          "https://twitter.com/intent/tweet?via=kanade_k_1228&related=kanade_k_1228&url=" +
            location.href +
            "&text=" +
            "カルマンフィルタ",
          "_blank"
        );
      }
    </script>
    <script src="https://kanade-k-1228.github.io/.common/changeStyle.js"></script>
    <script src="https://kanade-k-1228.github.io/.common/command.js"></script>
  </head>

  <body>
    <article>
      <header>
        <ul>
          <li><a href="/">ﾎｰﾑ</a></li>
          <li><a href="/Portfolio/">ﾎﾟﾄﾌｫﾘｵ</a></li>
          <li><a href="/Lab/">研究室</a></li>
          <li><a href="/Blog/">雑記</a></li>
        </ul>
        <div id="header-links">
          <a href="https://twitter.com/kanade_k_1228" target="_blank">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="50"
              height="50"
              viewBox="126.444 2.281 589 589"
              style="margin: 0; padding: 0"
            >
              <circle cx="420.944" cy="296.781" r="294.5" fill="#2daae1" />
              <path
                d="M609.773 179.634c-13.891 6.164-28.811 10.331-44.498 12.204 16.01-9.587 28.275-24.779 34.066-42.86a154.78 154.78 0 0 1-49.209 18.801c-14.125-15.056-34.267-24.456-56.551-24.456-42.773 0-77.462 34.675-77.462 77.473 0 6.064.683 11.98 1.996 17.66-64.389-3.236-121.474-34.079-159.684-80.945-6.672 11.446-10.491 24.754-10.491 38.953 0 26.875 13.679 50.587 34.464 64.477a77.122 77.122 0 0 1-35.097-9.686v.979c0 37.54 26.701 68.842 62.145 75.961-6.511 1.784-13.344 2.716-20.413 2.716-4.998 0-9.847-.473-14.584-1.364 9.859 30.769 38.471 53.166 72.363 53.799-26.515 20.785-59.925 33.175-96.212 33.175-6.25 0-12.427-.373-18.491-1.104 34.291 21.988 75.006 34.824 118.759 34.824 142.496 0 220.428-118.052 220.428-220.428 0-3.361-.074-6.697-.236-10.021a157.855 157.855 0 0 0 38.707-40.158z"
                fill="#fff"
              />
            </svg>
          </a>
          <a href="https://github.com/kanade-k-1228" target="_blank">
            <svg
              width="50px"
              height="50px"
              viewBox="0 0 1024 1024"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                fill-rule="evenodd"
                clip-rule="evenodd"
                d="M8 0C3.58 0 0 3.58 0 8C0 11.54 2.29 14.53 5.47 15.59C5.87 15.66 6.02 15.42 6.02 15.21C6.02 15.02 6.01 14.39 6.01 13.72C4 14.09 3.48 13.23 3.32 12.78C3.23 12.55 2.84 11.84 2.5 11.65C2.22 11.5 1.82 11.13 2.49 11.12C3.12 11.11 3.57 11.7 3.72 11.94C4.44 13.15 5.59 12.81 6.05 12.6C6.12 12.08 6.33 11.73 6.56 11.53C4.78 11.33 2.92 10.64 2.92 7.58C2.92 6.71 3.23 5.99 3.74 5.43C3.66 5.23 3.38 4.41 3.82 3.31C3.82 3.31 4.49 3.1 6.02 4.13C6.66 3.95 7.34 3.86 8.02 3.86C8.7 3.86 9.38 3.95 10.02 4.13C11.55 3.09 12.22 3.31 12.22 3.31C12.66 4.41 12.38 5.23 12.3 5.43C12.81 5.99 13.12 6.7 13.12 7.58C13.12 10.65 11.25 11.33 9.47 11.53C9.76 11.78 10.01 12.26 10.01 13.01C10.01 14.08 10 14.94 10 15.21C10 15.42 10.15 15.67 10.55 15.59C13.71 14.53 16 11.53 16 8C16 3.58 12.42 0 8 0Z"
                transform="scale(64)"
                fill="#1B1F23"
              />
            </svg>
          </a>
          <a href="https://t.co/E5xtfEQs4A" target="_blank">
            <img
              src="https://kanade-k-1228.github.io/.common/niconico.png"
              width="50px"
              height="50px"
              style="border-radius: 50%"
          /></a>
          <a
            href="https://www.youtube.com/channel/UCoeuc9-XQ5EpeYSCn4ESpQw"
            target="_blank"
          >
            <svg
              width="50px"
              height="50px"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 333333 333333"
            >
              <path
                d="M166667 0c92048 0 166667 74619 166667 166667s-74619 166667-166667 166667S0 258715 0 166667 74619 0 166667 0zm84195 132297s-1678-11849-6843-17052c-6545-6843-13873-6887-17223-7283-24036-1751-60138-1751-60138-1751h-63s-36085 0-60135 1751c-3363 409-10681 437-17223 7283-5168 5203-6811 17052-6811 17052s-1711 13904-1711 27838v13029c0 13905 1709 27837 1709 27837s1678 11849 6811 17061c6542 6843 15139 6621 18977 7350 13761 1314 58457 1710 58457 1710s36133-64 60169-1783c3363-397 10678-438 17223-7284 5168-5202 6843-17065 6843-17065s1711-13904 1711-27837v-13028c-35-13905-1745-27837-1745-27837l-9 9-1-1zm-102010 56674v-48312l46437 24237-46437 24075z"
                fill="red"
              />
            </svg>
          </a>
        </div>
        <!-- End Top Nav -->
        <!-- Title -->
                <h1 style="margin: 0">カルマンフィルタ</h1>
                <!-- Date -->
                <!-- Description -->
              </header>

      <!-- TeX Macros -->
      <!-- prettier-ignore -->
      <p style="display: none">
      \[ \newcommand{dn}[3]{\frac{\mathrm{d}^{#3} #1}{\mathrm{d} #2^{#3}}}
      \newcommand{\d}[2]{\frac{\mathrm{d} #1}{\mathrm{d} #2}}
      \newcommand{\dd}[2]{\frac{\mathrm{d}^2 #1}{\mathrm{d} {#2}^2}}
      \newcommand{\ddd}[2]{\frac{\mathrm{d}^3 #1}{\mathrm{d} {#2}^3}}
      \newcommand{\pdn}[3]{\frac{\partial^{#3} #1}{\partial {#2}^{#3}}}
      \newcommand{\pd}[2]{\frac{\partial #1}{\partial #2}}
      \newcommand{\pdd}[2]{\frac{\partial^2 #1}{\partial {#2}^2}}
      \newcommand{\pddd}[2]{\frac{\partial^3 #1}{\partial {#2}^3}}
      \newcommand{\p}{\partial}
      \newcommand{\D}[2]{\frac{\mathrm{D} #1}{\mathrm{D} #2}}
      \newcommand{\Re}{\mathrm{Re}}
      \newcommand{\Im}{\mathrm{Im}}
      \newcommand{\bra}[1]{\left\langle #1 \right|}
      \newcommand{\ket}[1]{\left|#1 \right\rangle}
      \newcommand{\braket}[2]{\left\langle #1 \middle|#2 \right\rangle}
      \newcommand{\inner}[2]{\left\langle #1 ,#2 \right\rangle}
      \newcommand{\l}{\left} \newcommand{\m}{\middle} \newcommand{\r}{\right}
      \newcommand{\f}[2]{\frac{#1}{#2}} \newcommand{\eps}{\varepsilon}
      \newcommand{\ra}{\rightarrow} \newcommand{\F}{\mathcal{F}}
      \newcommand{\L}{\mathcal{L}} \newcommand{\t}{\quad}
      \newcommand{\intinf}{\int_{-\infty}^{+\infty}}
      \newcommand{\R}{\mathcal{R}} \newcommand{\C}{\mathcal{C}}
      \newcommand{\Z}{\mathcal{Z}} \newcommand{\bm}[1]{\boldsymbol{#1}} \]
    </p>

      <!-- Table of Contents -->
            <nav><ul>
<li><a href="#カルマンフィルタの基礎">カルマンフィルタの基礎</a>
<ul>
<li><a href="#予測">予測</a></li>
<li><a href="#観測">観測</a></li>
<li><a href="#更新">更新</a></li>
</ul></li>
<li><a href="#誤差状態カルマンフィルタ">誤差状態カルマンフィルタ</a>
<ul>
<li><a href="#状態方程式">状態方程式</a></li>
<li><a href="#観測方程式">観測方程式</a></li>
</ul></li>
<li><a href="#状態方程式-1">状態方程式</a>
<ul>
<li><a href="#ヤコビアン">ヤコビアン</a></li>
</ul></li>
<li><a href="#観測方程式-1">観測方程式</a>
<ul>
<li><a href="#imu">IMU</a></li>
<li><a href="#gps">GPS</a></li>
<li><a href="#カメラオドメトリ">カメラオドメトリ</a></li>
</ul></li>
</ul></nav>
       <p>Joan Solà の論文を参考に、ドローンの自己位置推定を実装する。</p>
<p><a href="https://arxiv.org/abs/1711.02508">Joan Solà, Quaternion kinematics for the error-state Kalman filter</a></p>
<p>東京大学 航空宇宙工学専攻 土屋研究室の方々による和訳版もある。</p>
<p><a href="https://www.flight.t.u-tokyo.ac.jp/?p=800">Joan Solá著”Quaternion kinematics for the error-state Kalman filter”の日本語翻訳の公開について | 土屋研究室 -東京大学</a></p>
<p>論文では加速度と角速度を操作量として扱っているが、本稿では状態量として扱っている点に注意されたい。</p>
<p><span class="math display">\[
\newcommand{\rot}{\mathrm{Rot}}
\newcommand{\w}{\omega}
\]</span></p>
<h2 id="カルマンフィルタの基礎">カルマンフィルタの基礎</h2>
<ul>
<li>状態方程式: <span class="math inline">\(x = Fx + Gw\)</span>, <span class="math inline">\(w \sim N(0,Q)\)</span>
<ul>
<li><span class="math inline">\(x\)</span>: 状態</li>
<li><span class="math inline">\(P\)</span>: 状態の共分散行列</li>
<li><span class="math inline">\(F\)</span>: 状態遷移モデル</li>
<li><span class="math inline">\(w\)</span>: ホワイトノイズ</li>
<li><span class="math inline">\(Q\)</span>: ホワイトノイズの共分散行列</li>
<li><span class="math inline">\(G\)</span>: ノイズモデル</li>
</ul></li>
<li>観測方程式: <span class="math inline">\(z = H x + v\)</span>, <span class="math inline">\(v \sim N(0,R)\)</span>
<ul>
<li><span class="math inline">\(z\)</span>: 観測値</li>
<li><span class="math inline">\(H\)</span>: 観測行列</li>
<li><span class="math inline">\(v\)</span>: 観測ノイズ</li>
<li><span class="math inline">\(R\)</span>: 観測ノイズの共分散行列</li>
</ul></li>
</ul>
<h3 id="予測">予測</h3>
<p>現在 <span class="math inline">\(t\)</span> の推定値から次の時刻 <span class="math inline">\(t+1\)</span> の推定値は、状態方程式から単純に推定される。</p>
<p><span class="math display">\[
x_{t+1|t} = F x_{t|t}
\]</span></p>
<p>しかし、推定値には真値との誤差があり、推定によって誤差は増大する。</p>
<p><span class="math display">\[
P_{t+1|t} = F P_{t|t} F^T + G Q G^T
\]</span></p>
<p>第一項は現在の推定値の誤差による分散で、第二項はプロセスノイズによる分散である。</p>
<p>直感的にわかるように、予測だけのよって状態を推定していては、分散は次々と増大する。</p>
<p><span class="math display">\[
x_{t|t} \rightarrow x_{t+1|t} \rightarrow x_{t+2|t}
\]</span></p>
<p><span class="math display">\[
P_{t|t} \preceq P_{t+1|t} \preceq P_{t+2|t}
\]</span></p>
<p>そこで、観測によって推定状態を補正する。</p>
<h3 id="観測">観測</h3>
<p>センサ値 <span class="math inline">\(z\)</span> が計測された。この値を基に、状態の推定値を補正する。</p>
<p>観測残差を求める。 <span class="math display">\[
e_t = z_t - H x_{t|t-1}
\]</span> 観測値と、予測されていた観測値の差を表している。</p>
<p>観測残差の分散を求める。 <span class="math display">\[
S_t = R + HP_{t|t-1}H^T
\]</span> 第一項はセンサのノイズに起因する分散で、第二項は予測誤差に起因する分散である。</p>
<p>カルマンゲインを求める。 <span class="math display">\[
K_t = P_{t|t-1}H^TS_t
\]</span> 観測値がどの程度信頼できるかを表している。</p>
<h3 id="更新">更新</h3>
<p>カルマンゲインを使って、状態の推定値と、推定値の分散を更新する。 <span class="math display">\[
x_{t|t} = x_{k|k-1} + K_t e_t
\]</span> 予測値と観測値の「加重平均」をとることで、最も確からしい状態の推定値が得られる。</p>
<p><span class="math display">\[
P_{t|t} = (I-K_tH)P_{t|t-1}
\]</span></p>
<h2 id="誤差状態カルマンフィルタ">誤差状態カルマンフィルタ</h2>
<h3 id="状態方程式">状態方程式</h3>
<p>真の状態 <span class="math inline">\(x_t\)</span> に対する状態方程式を <span class="math inline">\(f\)</span> とする。</p>
<p><span class="math display">\[
\dot{x_t} = f(x_t)
\]</span></p>
<p>誤差状態カルマンフィルタでは、真の状態 <span class="math inline">\(x_t\)</span> をノミナル状態 <span class="math inline">\(x\)</span> と誤差状態 <span class="math inline">\(\delta x\)</span> に分解する。</p>
<p><span class="math display">\[
x_t = x \oplus \delta x
\]</span></p>
<p>ここで演算子 <span class="math inline">\(\oplus\)</span> は、状態の「自然な足し算」を表す。具体的には、位置に対しては並進（ベクトルの加算）を、姿勢に対しては回転（回転群の積）を意味する。</p>
<p>状態方程式も、ノミナル状態方程式と誤差状態方程式に分解する。</p>
<p><span class="math display">\[
f(x_t) =  f(x \oplus \delta x)= f(x) \oplus f_e(x,\delta x)
\]</span></p>
<p>ノミナル状態方程式は、真の状態方程式と同じである。</p>
<p><span class="math display">\[
\dot{x} = f(x)
\]</span></p>
<p>誤差状態方程式は、ノミナル状態と真の状態の差分である。</p>
<p><span class="math display">\[
\dot{\delta x} = f_e(x,\delta x)
\]</span></p>
<p>誤差状態方程式は、<span class="math inline">\(O(\delta x^2) \rightarrow 0\)</span> とみなして線形化できる。</p>
<h3 id="観測方程式">観測方程式</h3>
<p><span class="math display">\[
z = h(x_t) = h(x \oplus \delta x)
\]</span></p>
<p>誤差状態カルマンフィルタでは、観測をもとに誤差状態を補正する。</p>
<p><span class="math display">\[
H := \left. \frac{\partial h}{\partial \delta x}\right|_x
\]</span></p>
<p>これは連鎖律から求めることができる。</p>
<p><span class="math display">\[
\left. \frac{\partial h}{\partial \delta x}\right|_x = \left. \frac{\partial h}{\partial x_t}\right|_x \left. \frac{\partial x_t}{\partial \delta x}\right|_x =: H_x X_{\delta x}
\]</span></p>
<p><span class="math inline">\(H_x\)</span> は観測方程式次第、つまりセンサ次第だが、<span class="math inline">\(X_{\delta x}\)</span> はモデルの状態ベクトルから自動的に定まる。</p>
<h2 id="状態方程式-1">状態方程式</h2>
<table>
<colgroup>
<col style="width: 14%" />
<col style="width: 4%" />
<col style="width: 19%" />
<col style="width: 10%" />
<col style="width: 52%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">状態</th>
<th style="text-align: left;"><span class="math inline">\(x\)</span></th>
<th style="text-align: left;"><span class="math inline">\(\dot{x}\)</span></th>
<th style="text-align: left;"><span class="math inline">\(\delta x\)</span></th>
<th style="text-align: left;"><span class="math inline">\(\dot{\delta x}\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">位置</td>
<td style="text-align: left;"><span class="math inline">\(p\)</span></td>
<td style="text-align: left;"><span class="math inline">\(\dot{p} = v\)</span></td>
<td style="text-align: left;"><span class="math inline">\(\delta p\)</span></td>
<td style="text-align: left;"><span class="math inline">\(\dot{\delta p} = \delta v\)</span></td>
</tr>
<tr class="even">
<td style="text-align: left;">姿勢</td>
<td style="text-align: left;"><span class="math inline">\(q\)</span></td>
<td style="text-align: left;"><span class="math inline">\(\dot{q} = \frac{1}{2}q \w\)</span></td>
<td style="text-align: left;"><span class="math inline">\(\delta \theta\)</span></td>
<td style="text-align: left;"><span class="math inline">\(\dot{\delta \theta} = \rot(\delta \theta) \, \rot(q) \, (\w + \delta \w)\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: left;">速度</td>
<td style="text-align: left;"><span class="math inline">\(v\)</span></td>
<td style="text-align: left;"><span class="math inline">\(\dot{v} = \rot(q) a\)</span></td>
<td style="text-align: left;"><span class="math inline">\(\delta v\)</span></td>
<td style="text-align: left;"><span class="math inline">\(\dot{\delta v} = \rot(\delta \theta) \, \rot(q) \, (a + \delta a)\)</span></td>
</tr>
<tr class="even">
<td style="text-align: left;">加速度</td>
<td style="text-align: left;"><span class="math inline">\(a\)</span></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"><span class="math inline">\(\delta a\)</span></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">加速度センサバイアス</td>
<td style="text-align: left;"><span class="math inline">\(a_b\)</span></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"><span class="math inline">\(\delta a_b\)</span></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">角速度</td>
<td style="text-align: left;"><span class="math inline">\(\w\)</span></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"><span class="math inline">\(\delta \w\)</span></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">角速度センサバイアス</td>
<td style="text-align: left;"><span class="math inline">\(\w_b\)</span></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"><span class="math inline">\(\delta \w_b\)</span></td>
<td style="text-align: left;"></td>
</tr>
</tbody>
</table>
<h3 id="ヤコビアン">ヤコビアン</h3>
<h2 id="観測方程式-1">観測方程式</h2>
<p>各種センサをカルマンフィルタで使う方法</p>
<h3 id="imu">IMU</h3>
<p>加速度の計測値 ＝ 機体の加速度 + 重力加速度 + バイアス + ノイズ</p>
<p>角速度の計測値 = 機体の角速度 + バイアス + ノイズ</p>
<h3 id="gps">GPS</h3>
<p>位置：緯度・経度・高度</p>
<p>速度：NED座標系での速度</p>
<p>姿勢：</p>
<h3 id="カメラオドメトリ">カメラオドメトリ</h3>
<p>速度・角速度：前のフレームから現在のフレームへの移動量を、機体座標系で出してきます</p>

      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="50"
        height="50"
        viewBox="126.444 2.281 589 589"
        style="margin: auto; padding: 0; display: block"
        onclick="tweet();"
      >
        <circle cx="420.944" cy="296.781" r="294.5" fill="#2daae1" />
        <path
          d="M609.773 179.634c-13.891 6.164-28.811 10.331-44.498 12.204 16.01-9.587 28.275-24.779 34.066-42.86a154.78 154.78 0 0 1-49.209 18.801c-14.125-15.056-34.267-24.456-56.551-24.456-42.773 0-77.462 34.675-77.462 77.473 0 6.064.683 11.98 1.996 17.66-64.389-3.236-121.474-34.079-159.684-80.945-6.672 11.446-10.491 24.754-10.491 38.953 0 26.875 13.679 50.587 34.464 64.477a77.122 77.122 0 0 1-35.097-9.686v.979c0 37.54 26.701 68.842 62.145 75.961-6.511 1.784-13.344 2.716-20.413 2.716-4.998 0-9.847-.473-14.584-1.364 9.859 30.769 38.471 53.166 72.363 53.799-26.515 20.785-59.925 33.175-96.212 33.175-6.25 0-12.427-.373-18.491-1.104 34.291 21.988 75.006 34.824 118.759 34.824 142.496 0 220.428-118.052 220.428-220.428 0-3.361-.074-6.697-.236-10.021a157.855 157.855 0 0 0 38.707-40.158z"
          fill="#fff"
        />
      </svg>
    </article>
  </body>
</html>
